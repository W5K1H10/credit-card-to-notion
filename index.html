<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>信用卡月結單至Notion</title>
    <!-- 使用 PDF.js 庫來解析PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- 使用 Tailwind CSS 簡化樣式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        .loading-text {
            color: white;
            font-weight: bold;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 4px;
            white-space: nowrap;
        }
        .input-required::after {
            content: "*";
            color: red;
            margin-left: 2px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">處理中，請稍候...</div>
    </div>

    <header class="bg-blue-600 text-white p-4 shadow">
        <h1 class="text-xl font-bold">信用卡月結單至Notion</h1>
    </header>

    <main class="container mx-auto p-4">
        <!-- 步驟導覽 -->
        <div class="steps mb-6">
            <div class="flex justify-between">
                <div id="step1" class="step flex-1 text-center font-semibold text-blue-600 border-b-2 border-blue-600 pb-2">上傳PDF</div>
                <div id="step2" class="step flex-1 text-center font-semibold text-gray-400 border-b-2 border-gray-200 pb-2">預覽資料</div>
                <div id="step3" class="step flex-1 text-center font-semibold text-gray-400 border-b-2 border-gray-200 pb-2">送出至Notion</div>
            </div>
        </div>

        <!-- 步驟1：上傳區域 -->
        <section id="upload-section" class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="text-lg font-semibold mb-4">上傳信用卡月結單</h2>
            
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mt-1 text-sm text-gray-600">
                    點擊上傳或拖放PDF檔案
                </p>
                <input id="pdf-upload" type="file" accept="application/pdf" class="hidden">
                <button id="upload-button" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    選擇檔案
                </button>
                <button id="image-upload-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    上傳圖片
                </button>
            </div>
        </section>

        <!-- 步驟2：交易預覽 -->
        <section id="preview-section" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">交易資料預覽</h2>
            
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-semibold text-yellow-800">Notion 連接設定</h3>
                <p class="text-sm text-yellow-700 mb-2">為保障安全性，每次上傳都需要輸入您的 Notion API 密鑰和資料庫 ID。您的密鑰不會被儲存或傳送到任何第三方服務。</p>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 input-required">Notion API 密鑰</label>
                    <input type="password" id="notion-token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="secret_xxxxxxxxxxx" required>
                    <p class="text-xs text-gray-500 mt-1">這個密鑰不會被儲存，僅用於本次上傳</p>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 input-required">Notion 資料庫 ID</label>
                    <input type="text" id="database-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" required>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700">CORS 代理 URL (選填)</label>
                    <input type="text" id="cors-proxy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="https://your-cors-proxy.workers.dev">
                    <p class="text-xs text-gray-500 mt-1">若您有自己的CORS代理，可在此填入。若留空，將嘗試使用預設代理</p>
                </div>
                <div class="mt-4">
                    <button id="test-connection" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm">
                        測試連接
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類別</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">付款方式</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-preview" class="bg-white divide-y divide-gray-200">
                        <!-- 交易資料會在這裡動態生成 -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between mt-6">
                <button id="back-to-upload" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    返回
                </button>
                <button id="proceed-to-submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    確認並送出
                </button>
            </div>
        </section>

        <!-- 步驟3：結果顯示 -->
        <section id="result-section" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">送出結果</h2>
            
            <div id="result-content" class="p-4">
                <!-- 結果訊息會在這裡顯示 -->
            </div>

            <div class="mt-6">
                <button id="new-upload" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    上傳新檔案
                </button>
            </div>
        </section>
        
        <!-- 錯誤訊息區域 -->
        <div id="error-alert" class="fixed bottom-20 right-4 max-w-md p-4 bg-red-100 border border-red-400 text-red-700 rounded shadow-lg hidden">
            <div class="flex">
                <div class="py-1 mr-2">
                    <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <p id="error-message" class="font-bold"></p>
                    <p id="error-details" class="text-sm"></p>
                </div>
                <button id="close-error" class="ml-auto">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 成功訊息區域 -->
        <div id="success-alert" class="fixed bottom-20 right-4 max-w-md p-4 bg-green-100 border border-green-400 text-green-700 rounded shadow-lg hidden">
            <div class="flex">
                <div class="py-1 mr-2">
                    <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <div>
                    <p id="success-message" class="font-bold"></p>
                    <p id="success-details" class="text-sm"></p>
                </div>
                <button id="close-success" class="ml-auto">
                    <svg class="h-5 w-5" fill="none" viewBox="0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <footer class="fixed bottom-0 w-full bg-white p-4 border-t border-gray-200 text-sm text-center text-gray-600">
        信用卡月結單至Notion應用 &copy; 2025
    </footer>

    <script>
        // 初始化 PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // 預設CORS代理（有多個選項，以備一個不可用時）
        const DEFAULT_PROXIES = [
            "https://corsproxy.io/?",
            "https://api.allorigins.win/raw?url=",
            "https://cors-anywhere.herokuapp.com/"
        ];
        
        // Notion API端點
        const NOTION_API_BASE = "https://api.notion.com/v1";
        const NOTION_VERSION = "2022-06-28";
        
        // 設置處理超時
        const PROCESSING_TIMEOUT = 60000; // 60秒
        let processingTimeoutId = null;
        
        // 改進 CORS 代理選擇邏輯
        async function getWorkingProxy() {
            try {
                const customProxy = document.getElementById('cors-proxy')?.value?.trim();
                if (customProxy) {
                    return customProxy.endsWith('/') ? customProxy : customProxy + '/';
                }
                
                for (const proxy of DEFAULT_PROXIES) {
                    try {
                        const testUrl = `${proxy}https://httpbin.org/get`;
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch(testUrl, {
                            method: 'GET',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            console.log(`使用代理: ${proxy}`);
                            return proxy;
                        }
                    } catch (error) {
                        console.log(`代理 ${proxy} 不可用`, error);
                    }
                }
            } catch (error) {
                console.error("選擇代理時出錯:", error);
            }
            
            console.warn("所有代理都不可用，使用默認代理");
            return DEFAULT_PROXIES[0];
        }

        // 顯示錯誤訊息
        function showError(message, details = "") {
            const errorAlert = document.getElementById('error-alert');
            const errorMessage = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');
            
            errorMessage.textContent = message;
            errorDetails.textContent = details;
            
            errorAlert.classList.remove('hidden');
            
            setTimeout(() => {
                errorAlert.classList.add('hidden');
            }, 5000);
        }
        
        // 顯示成功訊息
        function showSuccess(message, details = "") {
            const successAlert = document.getElementById('success-alert');
            const successMessage = document.getElementById('success-message');
            const successDetails = document.getElementById('success-details');
            
            successMessage.textContent = message;
            successDetails.textContent = details;
            
            successAlert.classList.remove('hidden');
            
            setTimeout(() => {
                successAlert.classList.add('hidden');
            }, 5000);
        }

        // 改進 API 請求的詳細日誌和錯誤處理
        async function callNotionAPI(endpoint, method, token, body = null) {
            try {
                const proxy = await getWorkingProxy();
                if (!proxy) {
                    throw new Error("無法選擇有效的代理");
                }

                const url = `${proxy}${NOTION_API_BASE}/${endpoint}`;
                console.log(`API請求: ${method} ${url}`, body ? `Body: ${JSON.stringify(body)}` : "");

                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Notion-Version': NOTION_VERSION,
                    'Content-Type': 'application/json'
                };

                const options = {
                    method: method,
                    headers: headers
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                options.signal = controller.signal;

                let response;
                try {
                    response = await fetch(url, options);
                    clearTimeout(timeoutId);
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.error("API請求超時:", url);
                        throw new Error("API請求超時");
                    }
                    console.error("網路錯誤或請求中止:", error.message, url);
                    throw new Error(`網路錯誤或請求中止: ${error.message}`);
                }

                if (!response.ok) {
                    let errorData;
                    let errorMessage = `HTTP 錯誤 ${response.status}: ${response.statusText}`;
                    try {
                        errorData = await response.json();
                        if (errorData && errorData.message) {
                            errorMessage = `API 錯誤: ${errorData.message}`;
                        } else if (errorData && errorData.code) {
                            errorMessage = `API 錯誤 (${errorData.code}): ${errorData.message || '未知Notion錯誤'}`;
                        }
                        console.error("API響應錯誤 (JSON):", errorData, "Status:", response.status);
                    } catch (e) {
                        try {
                            const textError = await response.text();
                            errorMessage = `API 錯誤 ${response.status}: ${textError.substring(0, 200)}`;
                            console.error("API響應錯誤 (Text):", textError, "Status:", response.status);
                        } catch (textE) {
                            console.error("無法解析API錯誤響應", "Status:", response.status);
                        }
                    }
                    throw new Error(errorMessage);
                }

                if (response.headers.get("content-length") === "0" || response.status === 204) {
                    return null; 
                }
                
                try {
                    return await response.json();
                } catch (jsonParseError) {
                    console.error("無法解析成功的API響應為JSON:", jsonParseError);
                    throw new Error("API響應成功，但無法解析JSON內容");
                }

            } catch (error) { 
                console.error('API調用最終錯誤:', error.message);
                showError('API 調用失敗', error.message || '發生未知錯誤');
                throw error; 
            }
        }

        // 重構 Notion 連接診斷邏輯，使用 callNotionAPI
        async function diagnoseNotionConnection(notionToken, databaseId) {
            console.log("開始 Notion 連接診斷...");
            showLoading(true, "正在測試連接...");

            try {
                console.log("步驟 1: 測試 API 金鑰有效性 (users/me)...");
                try {
                    await callNotionAPI('users/me', 'GET', notionToken);
                    console.log("API 金鑰有效。");
                } catch (e) {
                    return { success: false, error: `API 金鑰測試失敗: ${e.message}. 請檢查您的 API 金鑰是否正確且具有所需權限。` };
                }

                console.log(`步驟 2: 測試資料庫訪問 (${databaseId})...`);
                let dbData;
                try {
                    dbData = await callNotionAPI(`databases/${databaseId}`, 'GET', notionToken);
                    if (!dbData) {
                        throw new Error("成功獲取資料庫，但未返回數據。");
                    }
                    console.log("資料庫可訪問。");
                } catch (e) {
                    return { success: false, error: `資料庫訪問測試失敗: ${e.message}. 請檢查資料庫ID是否正確，以及您的 Notion Integration 是否已共享給此資料庫並具有讀取權限。` };
                }

                console.log("步驟 3: 檢查資料庫結構...");
                const requiredProperties = ['名稱', '金額', '日期', '類別', '備註', '付款方式'];
                const missingProperties = [];
                const dbProperties = dbData.properties || {};

                for (const propName of requiredProperties) {
                    if (!dbProperties[propName]) {
                        missingProperties.push(propName);
                    }
                }

                if (missingProperties.length > 0) {
                    const errorMsg = `資料庫結構檢查失敗: 缺少必要欄位: ${missingProperties.join(', ')}。請確保資料庫包含這些欄位 (且名稱完全匹配)：${requiredProperties.join(', ')}。`;
                    console.warn(errorMsg);
                    return { success: false, error: errorMsg };
                }
                console.log("資料庫結構有效。");

                return { success: true, message: "連接成功！API 金鑰有效，資料庫可訪問且結構正確。" };

            } catch (error) {
                console.error("診斷過程中發生未預期錯誤:", error);
                return { success: false, error: `診斷過程中發生意外錯誤: ${error.message}` };
            } finally {
                showLoading(false);
            }
        }

        function showLoading(isLoading, message = "處理中，請稍候...") {
            const loadingDiv = document.getElementById('loading');
            if (!loadingDiv) return;
            const loadingText = loadingDiv.querySelector('.loading-text');
            
            if (isLoading) {
                if (loadingText) loadingText.textContent = message;
                loadingDiv.style.display = 'flex';
            } else {
                loadingDiv.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const testConnectionButton = document.getElementById('test-connection');
            if (testConnectionButton) {
                testConnectionButton.addEventListener('click', async () => {
                    const token = document.getElementById('notion-token').value;
                    const dbId = document.getElementById('database-id').value;

                    if (!token || !dbId) {
                        showError("請輸入 Notion API 金鑰和資料庫 ID。");
                        return;
                    }
                    
                    document.getElementById('error-alert').classList.add('hidden');
                    document.getElementById('success-alert').classList.add('hidden');

                    const result = await diagnoseNotionConnection(token, dbId);
                    
                    if (result.success) {
                        showSuccess("連接測試成功！", result.message);
                    } else {
                        showError("連接測試失敗", result.error);
                    }
                });
            }

            const closeErrorButton = document.getElementById('close-error');
            if (closeErrorButton) {
                closeErrorButton.addEventListener('click', () => {
                    document.getElementById('error-alert').classList.add('hidden');
                });
            }

            const closeSuccessButton = document.getElementById('close-success');
            if (closeSuccessButton) {
                closeSuccessButton.addEventListener('click', () => {
                    document.getElementById('success-alert').classList.add('hidden');
                });
            }
        });
    </script>
</body>
</html>
