<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>信用卡月結單至Notion</title>
    <!-- 使用 PDF.js 庫來解析PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- 使用 Tailwind CSS 簡化樣式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        .loading-text {
            color: white;
            font-weight: bold;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 4px;
            white-space: nowrap;
        }
        .input-required::after {
            content: "*";
            color: red;
            margin-left: 2px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">處理中，請稍候...</div>
    </div>

    <header class="bg-blue-600 text-white p-4 shadow">
        <h1 class="text-xl font-bold">信用卡月結單至Notion</h1>
    </header>

    <main class="container mx-auto p-4">
        <!-- 步驟導覽 -->
        <div class="steps mb-6">
            <div class="flex justify-between">
                <div id="step1" class="step flex-1 text-center font-semibold text-blue-600 border-b-2 border-blue-600 pb-2">上傳PDF</div>
                <div id="step2" class="step flex-1 text-center font-semibold text-gray-400 border-b-2 border-gray-200 pb-2">預覽資料</div>
                <div id="step3" class="step flex-1 text-center font-semibold text-gray-400 border-b-2 border-gray-200 pb-2">送出至Notion</div>
            </div>
        </div>

        <!-- 步驟1：上傳區域 -->
        <section id="upload-section" class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="text-lg font-semibold mb-4">上傳信用卡月結單</h2>
            
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mt-1 text-sm text-gray-600">
                    點擊上傳或拖放PDF檔案
                </p>
                <input id="pdf-upload" type="file" accept="application/pdf" class="hidden">
                <button id="upload-button" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    選擇檔案
                </button>
                <button id="image-upload-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    上傳圖片
                </button>
            </div>
        </section>

        <!-- 步驟2：交易預覽 -->
        <section id="preview-section" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">交易資料預覽</h2>
            
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-semibold text-yellow-800">Notion 連接設定</h3>
                <p class="text-sm text-yellow-700 mb-2">為保障安全性，每次上傳都需要輸入您的 Notion API 密鑰和資料庫 ID。您的密鑰不會被儲存或傳送到任何第三方服務。</p>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 input-required">Notion API 密鑰</label>
                    <input type="password" id="notion-token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="secret_xxxxxxxxxxx" required>
                    <p class="text-xs text-gray-500 mt-1">這個密鑰不會被儲存，僅用於本次上傳</p>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 input-required">Notion 資料庫 ID</label>
                    <input type="text" id="database-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" required>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700">CORS 代理 URL (選填)</label>
                    <input type="text" id="cors-proxy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="https://your-cors-proxy.workers.dev">
                    <p class="text-xs text-gray-500 mt-1">若您有自己的CORS代理，可在此填入。若留空，將嘗試使用預設代理</p>
                </div>
                <div class="mt-4">
                    <button id="test-connection" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm">
                        測試連接
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類別</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">付款方式</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-preview" class="bg-white divide-y divide-gray-200">
                        <!-- 交易資料會在這裡動態生成 -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between mt-6">
                <button id="back-to-upload" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    返回
                </button>
                <button id="proceed-to-submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    確認並送出
                </button>
            </div>
        </section>

        <!-- 步驟3：結果顯示 -->
        <section id="result-section" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">送出結果</h2>
            
            <div id="result-content" class="p-4">
                <!-- 結果訊息會在這裡顯示 -->
            </div>

            <div class="mt-6">
                <button id="new-upload" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    上傳新檔案
                </button>
            </div>
        </section>
        
        <!-- 錯誤訊息區域 -->
        <div id="error-alert" class="fixed bottom-20 right-4 max-w-md p-4 bg-red-100 border border-red-400 text-red-700 rounded shadow-lg hidden">
            <div class="flex">
                <div class="py-1 mr-2">
                    <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <p id="error-message" class="font-bold"></p>
                    <p id="error-details" class="text-sm"></p>
                </div>
                <button id="close-error" class="ml-auto">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 成功訊息區域 -->
        <div id="success-alert" class="fixed bottom-20 right-4 max-w-md p-4 bg-green-100 border border-green-400 text-green-700 rounded shadow-lg hidden">
            <div class="flex">
                <div class="py-1 mr-2">
                    <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <div>
                    <p id="success-message" class="font-bold"></p>
                    <p id="success-details" class="text-sm"></p>
                </div>
                <button id="close-success" class="ml-auto">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <footer class="fixed bottom-0 w-full bg-white p-4 border-t border-gray-200 text-sm text-center text-gray-600">
        信用卡月結單至Notion應用 &copy; 2025
    </footer>

    <script>
        // 初始化 PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // 預設CORS代理（有多個選項，以備一個不可用時）
        const DEFAULT_PROXIES = [
            "https://corsproxy.io/?",
            "https://api.allorigins.win/raw?url=",
            "https://cors-anywhere.herokuapp.com/"
        ];
        
        // Notion API端點
        const NOTION_API_BASE = "https://api.notion.com/v1";
        const NOTION_VERSION = "2022-06-28";
        
        // 設置處理超時
        const PROCESSING_TIMEOUT = 60000; // 60秒
        let processingTimeoutId = null;
        
        // 1. 改進 getWorkingProxy 函式，預設返回第一個代理
        async function getWorkingProxy() {
            try {
                // 檢查自定義代理
                const customProxy = document.getElementById('cors-proxy')?.value?.trim();
                if (customProxy) {
                    return customProxy.endsWith('/') ? customProxy : customProxy + '/';
                }

                // 測試每個預設代理
                for (const proxy of DEFAULT_PROXIES) {
                    try {
                        const testUrl = `${proxy}https://httpbin.org/get`;
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);

                        const response = await fetch(testUrl, {
                            method: 'GET',
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (response.ok) {
                            console.log(`使用代理: ${proxy}`);
                            return proxy;
                        }
                    } catch (error) {
                        console.warn(`代理 ${proxy} 不可用:`, error.message);
                    }
                }
                
                // 如果所有代理都失敗，預設返回第一個代理並顯示警告
                console.warn("所有代理測試失敗，使用預設代理:", DEFAULT_PROXIES[0]);
                return DEFAULT_PROXIES[0];
            } catch (error) {
                console.error("選擇代理時出錯:", error);
                // 發生錯誤時仍返回第一個代理
                return DEFAULT_PROXIES[0];
            }
        }

        // 2. 增強 callNotionAPI 函式
        async function callNotionAPI(endpoint, method = 'GET', data = null, notionToken = null, retryCount = 3) {
            if (!notionToken) {
                notionToken = document.getElementById('notion-token')?.value;
                if (!notionToken) {
                    throw new Error("缺少Notion API密鑰");
                }
            }
            
            try {
                // 獲取代理
                const proxy = await getWorkingProxy();
                const apiUrl = `${proxy}${NOTION_API_BASE}${endpoint}`;
                
                // 準備請求選項
                const options = {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${notionToken}`,
                        'Notion-Version': NOTION_VERSION,
                        'Content-Type': 'application/json'
                    }
                };
                
                // 如果有資料，轉換為JSON
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                // 發送請求
                const response = await fetch(apiUrl, options);
                
                // 檢查響應狀態
                if (!response.ok) {
                    // 嘗試解析錯誤響應
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || `HTTP錯誤 ${response.status}`;
                    } catch (e) {
                        errorMessage = `HTTP錯誤 ${response.status}`;
                    }
                    
                    // 創建帶有HTTP狀態碼的錯誤對象
                    const error = new Error(errorMessage);
                    error.status = response.status;
                    error.endpoint = endpoint;
                    throw error;
                }
                
                // 返回成功響應的JSON數據
                return await response.json();
                
            } catch (error) {
                // 處理重試邏輯
                if (retryCount > 0 && (!error.status || error.status >= 500)) {
                    console.warn(`API呼叫失敗，重試中 (${retryCount} 次餘額)...`, error.message);
                    // 延遲1秒後重試
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return callNotionAPI(endpoint, method, data, notionToken, retryCount - 1);
                }
                
                // 詳細記錄錯誤
                console.error("Notion API呼叫失敗:", error);
                
                // 處理特定錯誤碼
                if (error.status === 401) {
                    throw new Error("API密鑰無效或過期");
                } else if (error.status === 404) {
                    throw new Error("找不到資源，請檢查資料庫ID是否正確");
                } else if (error.status === 403) {
                    throw new Error("無權限訪問此資源，請確保API密鑰有足夠權限");
                }
                
                // 重新拋出其他錯誤
                throw error;
            }
        }

        // 3. 重構 diagnoseNotionConnection 函式
        async function diagnoseNotionConnection(notionToken, databaseId) {
            try {
                // 步驟 1: 測試 API 密鑰有效性
                console.log("測試 API 密鑰...");
                try {
                    const userData = await callNotionAPI('/users/me', 'GET', null, notionToken);
                    console.log("API 密鑰有效，用戶資訊:", userData);
                } catch (error) {
                    if (error.message.includes("API密鑰無效")) {
                        return { success: false, error: "API 密鑰無效或過期" };
                    }
                    return { success: false, error: `API 連接錯誤: ${error.message}` };
                }
                
                // 步驟 2: 測試資料庫訪問
                console.log("測試資料庫訪問...");
                let dbData;
                try {
                    dbData = await callNotionAPI(`/databases/${databaseId}`, 'GET', null, notionToken);
                    console.log("資料庫訪問成功:", dbData.title);
                } catch (error) {
                    if (error.message.includes("找不到資源")) {
                        return { success: false, error: "找不到資料庫，請檢查資料庫 ID 是否正確" };
                    } else if (error.message.includes("無權限")) {
                        return { success: false, error: "沒有權限訪問此資料庫，請確保已共享給您的整合" };
                    }
                    return { success: false, error: `資料庫訪問錯誤: ${error.message}` };
                }
                
                // 步驟 3: 檢查資料庫結構
                const requiredProperties = ['名稱', '金額', '日期', '類別', '備註', '付款方式'];
                const missingProperties = [];
                
                for (const prop of requiredProperties) {
                    if (!dbData.properties[prop]) {
                        missingProperties.push(prop);
                    }
                }
                
                if (missingProperties.length > 0) {
                    return { 
                        success: false, 
                        error: `資料庫缺少必要欄位: ${missingProperties.join(', ')}` 
                    };
                }
                
                return { success: true, message: "連接成功！API 密鑰有效，資料庫可訪問，結構正確。" };
                
            } catch (error) {
                console.error("診斷過程中發生錯誤:", error);
                return { success: false, error: `診斷過程中發生錯誤: ${error.message}` };
            }
        }

        // 5. 改進 showLoading 函式，檢查 loadingDiv 是否存在
        function showLoading(message = "處理中，請稍候...") {
            const loadingDiv = document.getElementById('loading');
            if (!loadingDiv) {
                console.error("找不到loading元素");
                return;
            }
            
            const loadingText = loadingDiv.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = message;
            }
            
            loadingDiv.style.display = 'flex';
            
            // 設置超時處理
            clearTimeout(processingTimeoutId);
            processingTimeoutId = setTimeout(() => {
                hideLoading();
                showError("處理超時", "操作花費太長時間，請重試或聯繫支持");
            }, PROCESSING_TIMEOUT);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            clearTimeout(processingTimeoutId);
        }

        // 顯示錯誤訊息
        function showError(message, details = "") {
            const errorAlert = document.getElementById('error-alert');
            const errorMessage = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');

            errorMessage.textContent = message;
            errorDetails.textContent = details;

            errorAlert.classList.remove('hidden');

            setTimeout(() => {
                errorAlert.classList.add('hidden');
            }, 5000);
        }
        
        // 顯示成功訊息
        function showSuccess(message, details = "") {
            const successAlert = document.getElementById('success-alert');
            const successMessage = document.getElementById('success-message');
            const successDetails = document.getElementById('success-details');
            
            successMessage.textContent = message;
            successDetails.textContent = details;
            
            successAlert.classList.remove('hidden');
            
            // 5秒後自動隱藏
            setTimeout(() => {
                successAlert.classList.add('hidden');
            }, 5000);
        }

        // 4. 更新 DOMContentLoaded 事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            // 獲取DOM元素
            const uploadSection = document.getElementById('upload-section');
            const previewSection = document.getElementById('preview-section');
            const resultSection = document.getElementById('result-section');
            const uploadButton = document.getElementById('upload-button');
            const imageUploadButton = document.getElementById('image-upload-button');
            const pdfUpload = document.getElementById('pdf-upload');
            const dropZone = document.getElementById('drop-zone');
            const backToUploadBtn = document.getElementById('back-to-upload');
            const proceedToSubmitBtn = document.getElementById('proceed-to-submit');
            const newUploadBtn = document.getElementById('new-upload');
            const testConnectionBtn = document.getElementById('test-connection');
            const closeErrorBtn = document.getElementById('close-error');
            const closeSuccessBtn = document.getElementById('close-success');

            // 步驟導航
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            
            // 檢查必要元素是否存在
            if (!uploadSection || !previewSection || !resultSection || !uploadButton || 
                !pdfUpload || !dropZone || !backToUploadBtn || !proceedToSubmitBtn || 
                !newUploadBtn || !testConnectionBtn) {
                console.error("找不到必要的DOM元素");
                return;
            }

            // 上傳按鈕點擊處理
            uploadButton.addEventListener('click', function() {
                pdfUpload.click();
            });
            
            // 處理PDF文件上傳
            pdfUpload.addEventListener('change', async function(e) {
                if (e.target.files.length === 0) return;
                
                const file = e.target.files[0];
                if (file.type !== 'application/pdf') {
                    showError("檔案格式錯誤", "請上傳PDF檔案");
                    return;
                }
                
                showLoading("正在解析PDF檔案...");
                
                try {
                    // 在這裡處理PDF解析邏輯
                    // ...

                    // 顯示預覽部分
                    uploadSection.classList.add('hidden');
                    previewSection.classList.remove('hidden');
                    step1.classList.remove('text-blue-600', 'border-blue-600');
                    step1.classList.add('text-gray-400', 'border-gray-200');
                    step2.classList.remove('text-gray-400', 'border-gray-200');
                    step2.classList.add('text-blue-600', 'border-blue-600');
                    
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    showError("PDF解析失敗", error.message);
                    console.error("PDF解析錯誤:", error);
                }
            });
            
            // 處理圖片上傳按鈕點擊
            imageUploadButton.addEventListener('click', function() {
                // 創建臨時文件輸入元素
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                // 監聽文件選擇
                input.addEventListener('change', async function(e) {
                    if (e.target.files.length === 0) return;
                    
                    const file = e.target.files[0];
                    showLoading("正在處理圖片...");
                    
                    try {
                        // 在這裡處理圖片OCR邏輯
                        // ...
                        
                        // 顯示預覽部分
                        uploadSection.classList.add('hidden');
                        previewSection.classList.remove('hidden');
                        step1.classList.remove('text-blue-600', 'border-blue-600');
                        step1.classList.add('text-gray-400', 'border-gray-200');
                        step2.classList.remove('text-gray-400', 'border-gray-200');
                        step2.classList.add('text-blue-600', 'border-blue-600');
                        
                        hideLoading();
                    } catch (error) {
                        hideLoading();
                        showError("圖片處理失敗", error.message);
                        console.error("圖片處理錯誤:", error);
                    }
                });
                
                // 觸發文件選擇對話框
                input.click();
            });
            
            // 返回按鈕處理
            backToUploadBtn.addEventListener('click', function() {
                previewSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                step2.classList.remove('text-blue-600', 'border-blue-600');
                step2.classList.add('text-gray-400', 'border-gray-200');
                step1.classList.remove('text-gray-400', 'border-gray-200');
                step1.classList.add('text-blue-600', 'border-blue-600');
            });
            
            // 送出按鈕處理
            proceedToSubmitBtn.addEventListener('click', async function() {
                const notionToken = document.getElementById('notion-token').value;
                const databaseId = document.getElementById('database-id').value;
                
                if (!notionToken || !databaseId) {
                    showError("請填寫必要欄位", "Notion API密鑰和資料庫ID為必填項");
                    return;
                }
                
                showLoading("正在送出至Notion...");
                
                try {
                    // 在這裡處理送出至Notion的邏輯
                    // ...
                    
                    // 顯示結果部分
                    previewSection.classList.add('hidden');
                    resultSection.classList.remove('hidden');
                    step2.classList.remove('text-blue-600', 'border-blue-600');
                    step2.classList.add('text-gray-400', 'border-gray-200');
                    step3.classList.remove('text-gray-400', 'border-gray-200');
                    step3.classList.add('text-blue-600', 'border-blue-600');
                    
                    // 更新結果內容
                    document.getElementById('result-content').innerHTML = `
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <svg class="h-12 w-12 text-green-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            <h3 class="text-lg font-semibold text-center text-green-800">送出成功</h3>
                            <p class="text-center text-green-700 mt-2">資料已成功送出至您的Notion資料庫</p>
                        </div>
                    `;
                    
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    showError("送出至Notion失敗", error.message);
                    console.error("Notion送出錯誤:", error);
                }
            });
            
            // 上傳新檔案按鈕處理
            newUploadBtn.addEventListener('click', function() {
                resultSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                step3.classList.remove('text-blue-600', 'border-blue-600');
                step3.classList.add('text-gray-400', 'border-gray-200');
                step1.classList.remove('text-gray-400', 'border-gray-200');
                step1.classList.add('text-blue-600', 'border-blue-600');
                
                // 重置文件輸入
                pdfUpload.value = '';
            });
            
            // 測試連接按鈕點擊處理
            testConnectionBtn.addEventListener('click', async function() {
                const notionToken = document.getElementById('notion-token').value;
                const databaseId = document.getElementById('database-id').value;
                
                if (!notionToken || !databaseId) {
                    showError("請填寫必要欄位", "Notion API密鑰和資料庫ID為必填項");
                    return;
                }
                
                showLoading("測試Notion連接中...");
                
                try {
                    const result = await diagnoseNotionConnection(notionToken, databaseId);
                    hideLoading();
                    
                    if (result.success) {
                        showSuccess("連接測試成功", result.message);
                    } else {
                        showError("連接測試失敗", result.error);
                    }
                } catch (error) {
                    hideLoading();
                    showError("連接測試過程中出錯", error.message);
                    console.error("連接測試錯誤:", error);
                }
            });
            
            // 拖放區域處理
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            // 拖放區域視覺效果
            dropZone.addEventListener('dragenter', function() {
                this.classList.add('border-blue-500');
            });
            
            dropZone.addEventListener('dragleave', function() {
                this.classList.remove('border-blue-500');
            });
            
            dropZone.addEventListener('drop', function(e) {
                this.classList.remove('border-blue-500');
                
                const file = e.dataTransfer.files[0];
                if (!file) return;
                
                if (file.type === 'application/pdf') {
                    pdfUpload.files = e.dataTransfer.files;
                    const event = new Event('change');
                    pdfUpload.dispatchEvent(event);
                } else if (file.type.startsWith('image/')) {
                    // 處理拖放的圖片
                    const event = new Event('change');
                    const input = document.createElement('input');
                    input.files = e.dataTransfer.files;
                    imageUploadButton.dispatchEvent(event);
                } else {
                    showError("不支援的檔案類型", "請上傳PDF檔案或圖片");
                }
            });
            
            // 關閉錯誤訊息
            if (closeErrorBtn) {
                closeErrorBtn.addEventListener('click', function() {
                    document.getElementById('error-alert').classList.add('hidden');
                });
            }
            
            // 關閉成功訊息
            if (closeSuccessBtn) {
                closeSuccessBtn.addEventListener('click', function() {
                    document.getElementById('success-alert').classList.add('hidden');
                });
            }
        });

        // 更新商家分類對照表以匹配Notion中的固定類別
        const categoryMap = {
            // 生活用品
            'SUPERMARKET': '生活用品', 'PARKNSHOP': '生活用品', 'WELLCOME': '生活用品',
            'WATSONS': '生活用品', 'MARKET': '生活用品',

            // 知識學習
            'BOOKSTORE': '知識學習', 'COURSE': '知識學習', 'EDUCATION': '知識學習',

            // 休閒娛樂
            'MOVIE': '休閒娛樂', 'CINEMA': '休閒娛樂', 'NETFLIX': '休閒娛樂',
            'SPOTIFY': '休閒娛樂', 'DISNEY': '休閒娛樂', 'GAME': '休閒娛樂',

            // 交通
            'UBER': '交通', 'TAXI': '交通', 'MTR': '交通', 'BUS': '交通',
            'TRANSPORT': '交通', 'OCTOPUS': '交通',

            // 健康醫療
            'DOCTOR': '健康醫療', 'CLINIC': '健康醫療', 'HOSPITAL': '健康醫療',
            'PHARMACY': '健康醫療', 'MEDICAL': '健康醫療',

            // 訂閱
            'SUBSCRIPTION': '訂閱', 'MAGAZINE': '訂閱', 'MEMBERSHIP': '訂閱',

            // 固定支出
            'RENT': '固定支出', 'MORTGAGE': '固定支出', 'LOAN': '固定支出',

            // 美妝
            'COSMETICS': '美妝', 'BEAUTY': '美妝', 'SKINCARE': '美妝',

            // 服飾配件
            'CLOTHING': '服飾配件', 'FASHION': '服飾配件', 'ACCESSORIES': '服飾配件',

            // 餐飲
            'CAFE': '餐飲', 'RESTAURANT': '餐飲', 'DINING': '餐飲', 'FOOD': '餐飲',
            'BAKERY': '餐飲', 'COFFEE': '餐飲'
        };
    </script>
</body>
</html>
