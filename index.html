<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>信用卡月結單至Notion</title>
    <!-- 使用 PDF.js 庫來解析PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- 使用 Tailwind CSS 簡化樣式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        .loading-text {
            color: white;
            font-weight: bold;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 4px;
            white-space: nowrap;
        }
        .input-required::after {
            content: "*";
            color: red;
            margin-left: 2px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">處理中，請稍候...</div>
    </div>

    <header class="bg-blue-600 text-white p-4 shadow">
        <h1 class="text-xl font-bold">信用卡月結單至Notion</h1>
    </header>

    <main class="container mx-auto p-4">
        <!-- 步驟導覽 -->
        <div class="steps mb-6">
            <div class="flex justify-between">
                <div id="step1" class="step flex-1 text-center font-semibold text-blue-600 border-b-2 border-blue-600 pb-2">上傳PDF</div>
                <div id="step2" class="step flex-1 text-center font-semibold text-gray-400 border-b-2 border-gray-200 pb-2">預覽資料</div>
                <div id="step3" class="step flex-1 text-center font-semibold text-gray-400 border-b-2 border-gray-200 pb-2">送出至Notion</div>
            </div>
        </div>

        <!-- 步驟1：上傳區域 -->
        <section id="upload-section" class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="text-lg font-semibold mb-4">上傳信用卡月結單</h2>
            
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mt-1 text-sm text-gray-600">
                    點擊上傳或拖放PDF檔案
                </p>
                <input id="pdf-upload" type="file" accept="application/pdf" class="hidden">
                <button id="upload-button" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    選擇檔案
                </button>
                <button id="image-upload-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    上傳圖片
                </button>
            </div>
        </section>

        <!-- 步驟2：交易預覽 -->
        <section id="preview-section" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">交易資料預覽</h2>
            
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-semibold text-yellow-800">Notion 連接設定</h3>
                <p class="text-sm text-yellow-700 mb-2">為保障安全性，每次上傳都需要輸入您的 Notion API 密鑰和資料庫 ID。您的密鑰不會被儲存或傳送到任何第三方服務。</p>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 input-required">Notion API 密鑰</label>
                    <input type="text" id="notion-token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" required>
                    <p class="text-xs text-gray-500 mt-1">這個密鑰不會被儲存，僅用於本次上傳</p>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 input-required">Notion 資料庫 ID</label>
                    <input type="text" id="database-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" required>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700">CORS 代理 URL (選填)</label>
                    <input type="text" id="cors-proxy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="https://your-cors-proxy.workers.dev">
                    <p class="text-xs text-gray-500 mt-1">若您有自己的CORS代理，可在此填入。若留空，將嘗試使用預設代理</p>
                </div>
                <div class="mt-4">
                    <button id="test-connection" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm">
                        測試連接
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類別</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">付款方式</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-preview" class="bg-white divide-y divide-gray-200">
                        <!-- 交易資料會在這裡動態生成 -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between mt-6">
                <button id="back-to-upload" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    返回
                </button>
                <button id="proceed-to-submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    確認並送出
                </button>
            </div>
        </section>

        <!-- 步驟3：結果顯示 -->
        <section id="result-section" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">送出結果</h2>
            
            <div id="result-content" class="p-4">
                <!-- 結果訊息會在這裡顯示 -->
            </div>

            <div class="mt-6">
                <button id="new-upload" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    上傳新檔案
                </button>
            </div>
        </section>
        
        <!-- 錯誤訊息區域 -->
        <div id="error-alert" class="fixed bottom-20 right-4 max-w-md p-4 bg-red-100 border border-red-400 text-red-700 rounded shadow-lg hidden">
            <div class="flex">
                <div class="py-1 mr-2">
                    <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <p id="error-message" class="font-bold"></p>
                    <p id="error-details" class="text-sm"></p>
                </div>
                <button id="close-error" class="ml-auto">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 成功訊息區域 -->
        <div id="success-alert" class="fixed bottom-20 right-4 max-w-md p-4 bg-green-100 border border-green-400 text-green-700 rounded shadow-lg hidden">
            <div class="flex">
                <div class="py-1 mr-2">
                    <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <div>
                    <p id="success-message" class="font-bold"></p>
                    <p id="success-details" class="text-sm"></p>
                </div>
                <button id="close-success" class="ml-auto">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <footer class="fixed bottom-0 w-full bg-white p-4 border-t border-gray-200 text-sm text-center text-gray-600">
        信用卡月結單至Notion應用 &copy; 2025
    </footer>

    <script>
        // 初始化 PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // 預設CORS代理（有多個選項，以備一個不可用時）
        const DEFAULT_PROXIES = [
            "https://corsproxy.io/?",
            "https://api.allorigins.win/raw?url=",
            "https://cors-anywhere.herokuapp.com/"
        ];
        
        // Notion API端點
        const NOTION_API_BASE = "https://api.notion.com/v1";
        const NOTION_VERSION = "2022-06-28";  // 當前最新的Notion API版本
        
        // 設置處理超時
        const PROCESSING_TIMEOUT = 60000; // 60秒
        let processingTimeoutId = null;
        
// 修改getWorkingProxy函數
async function getWorkingProxy() {
    const customProxy = document.getElementById('cors-proxy')?.value?.trim();
    if (customProxy) {
        // 確保自定義代理URL格式正確
        return customProxy.endsWith('?apiurl=') ? customProxy : customProxy + '?apiurl=';
    }
    
    // 測試並選擇默認代理
    for (const proxy of DEFAULT_PROXIES) {
        try {
            const testUrl = `${proxy}https://httpbin.org/get`;
            const response = await fetch(testUrl, { method: 'GET' });
            if (response.ok) {
                console.log(`代理可用: ${proxy}`);
                return proxy;
            }
        } catch (e) {
            console.warn(`代理不可用: ${proxy}`);
        }
    }
    
    // 如果所有代理都不可用，提供明確的錯誤提示
    throw new Error('無法連接到任何CORS代理，請嘗試使用自定義代理或安裝CORS瀏覽器擴充功能');
}

        // 顯示錯誤訊息
        function showError(message, details = "") {
            const errorAlert = document.getElementById('error-alert');
            const errorMessage = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');
            
            errorMessage.textContent = message;
            errorDetails.textContent = details;
            
            errorAlert.classList.remove('hidden');
            
            // 5秒後自動隱藏
            setTimeout(() => {
                errorAlert.classList.add('hidden');
            }, 5000);
        }
        
        // 顯示成功訊息
        function showSuccess(message, details = "") {
            const successAlert = document.getElementById('success-alert');
            const successMessage = document.getElementById('success-message');
            const successDetails = document.getElementById('success-details');
            
            successMessage.textContent = message;
            successDetails.textContent = details;
            
            successAlert.classList.remove('hidden');
            
            // 5秒後自動隱藏
            setTimeout(() => {
                successAlert.classList.add('hidden');
            }, 5000);
        }

        // 診斷 Notion 連接問題 - 更詳細的診斷步驟
        async function diagnoseNotionConnection(notionToken, databaseId) {
            console.log("開始診斷 Notion 連接...");
            
            try {
                // 步驟 1: 測試 API 密鑰有效性
                console.log("步驟 1: 測試 API 密鑰...");
                try {
                    const userData = await callNotionAPI('users/me', 'GET', notionToken);
                    console.log("API 密鑰有效，認證為:", userData.name || "未知用戶");
                } catch (error) {
                    console.error("API 密鑰測試失敗:", error);
                    return { 
                        success: false, 
                        error: `API 密鑰無效或有問題: ${error.message}`,
                        details: "請確認您的 Integration Token 是正確的，並且具有足夠權限。"
                    };
                }
                
                // 步驟 2: 測試資料庫訪問權限
                console.log(`步驟 2: 檢查資料庫 (${databaseId}) 訪問權限...`);
                try {
                    const dbData = await callNotionAPI(`databases/${databaseId}`, 'GET', notionToken);
                    console.log("成功訪問資料庫:", dbData.title?.[0]?.plain_text || databaseId);
                } catch (error) {
                    console.error("資料庫訪問測試失敗:", error);
                    let errorMsg = `無法訪問資料庫: ${error.message}`;
                    let details = "請確認資料庫ID是正確的，並且您的Integration已被授予訪問權限。";
                    
                    if (error.message.includes("找不到資源") || error.message.includes("404")) {
                        errorMsg = "找不到指定的資料庫";
                        details = "請檢查資料庫ID是否正確。在Notion分享資料庫時，請複製完整的URL，資料庫ID為URL中最後一段(包含連字符的部分)。";
                    } else if (error.message.includes("權限不足") || error.message.includes("403")) {
                        errorMsg = "您的Integration沒有訪問此資料庫的權限";
                        details = "請在Notion中將資料庫分享給您的Integration。點擊資料庫頁面右上角的「分享」按鈕，然後輸入您的Integration名稱並授予權限。";
                    }
                    
                    return { success: false, error: errorMsg, details: details };
                }
                
                // 步驟 3: 檢查資料庫結構
                console.log("步驟 3: 檢查資料庫結構...");
                try {
                    const dbData = await callNotionAPI(`databases/${databaseId}`, 'GET', notionToken);
                    const properties = dbData.properties || {};
                    const requiredProps = ['名稱', '金額', '日期', '類別', '備註', '付款方式'];
                    const missingProps = [];
                    
                    for (const prop of requiredProps) {
                        if (!properties[prop]) {
                            missingProps.push(prop);
                        }
                    }
                    
                    if (missingProps.length > 0) {
                        console.error("資料庫結構不完整，缺少欄位:", missingProps);
                        return {
                            success: false,
                            error: `資料庫結構不符合要求，缺少以下欄位: ${missingProps.join(", ")}`,
                            details: "請在Notion資料庫中新增缺少的欄位，確保名稱完全匹配。"
                        };
                    }
                    
                    // 檢查欄位類型
                    const typeCheck = {
                        '名稱': 'title',
                        '金額': 'number',
                        '日期': 'date',
                        '類別': 'select',
                        '備註': 'rich_text',
                        '付款方式': 'select'
                    };
                    
                    const wrongTypeProps = [];
                    for (const [prop, expectedType] of Object.entries(typeCheck)) {
                        const actualType = properties[prop]?.type;
                        if (actualType !== expectedType) {
                            wrongTypeProps.push(`${prop}(應為${expectedType}，實際為${actualType})`);
                        }
                    }
                    
                    if (wrongTypeProps.length > 0) {
                        console.error("資料庫欄位類型不正確:", wrongTypeProps);
                        return {
                            success: false,
                            error: `資料庫欄位類型不符合要求: ${wrongTypeProps.join(", ")}`,
                            details: "請在Notion資料庫中修正這些欄位的類型。"
                        };
                    }
                } catch (error) {
                    console.error("檢查資料庫結構時出錯:", error);
                    return {
                        success: false,
                        error: `無法檢查資料庫結構: ${error.message}`,
                        details: "請確保API密鑰有效且具有足夠權限。"
                    };
                }
                
                // 步驟 4: 測試創建頁面權限
                console.log("步驟 4: 測試創建頁面權限...");
                try {
                    // 創建一個測試頁面 (可選)
                    /*
                    const testPageData = {
                        parent: { database_id: databaseId },
                        properties: {
                            '名稱': { title: [{ text: { content: "[測試] 連接測試" } }] },
                            '金額': { number: 0 },
                            '日期': { date: { start: new Date().toISOString().split('T')[0] } },
                            '類別': { select: { name: "其他" } },
                            '備註': { rich_text: [{ text: { content: "連接測試，請忽略或刪除" } }] },
                            '付款方式': { select: { name: "信用卡" } }
                        }
                    };
                    
                    await callNotionAPI('pages', 'POST', notionToken, testPageData);
                    console.log("成功創建測試頁面");
                    */
                } catch (error) {
                    console.error("測試創建頁面失敗:", error);
                    return {
                        success: false,
                        error: `無法創建頁面: ${error.message}`,
                        details: "請確保您的Integration具有寫入權限。"
                    };
                }
                
                // 所有檢查通過
                console.log("所有診斷步驟通過，連接正常!");
                return {
                    success: true,
                    message: "連接測試成功！您的API密鑰和資料庫配置均正確。",
                    details: "您現在可以繼續將資料送出至Notion。"
                };
                
            } catch (error) {
                console.error("診斷過程中發生未預期錯誤:", error);
                return {
                    success: false,
                    error: `診斷過程中發生錯誤: ${error.message}`,
                    details: "這可能是網絡問題、CORS限制或API相關問題，請稍後再試。"
                };
            }
        }

        // 改進API請求函數，增加錯誤處理和重試機制
        async function callNotionAPI(endpoint, method, token, body = null) {
    let attempts = 0;
    const MAX_RETRIES = 2;
    
    while (attempts <= MAX_RETRIES) {
        try {
            attempts++;
            // 添加更詳細的日誌
            console.log(`API請求(${attempts}/${MAX_RETRIES+1}): ${endpoint}`);
            
            // 獲取代理並設置請求
            const proxy = await getWorkingProxy();
            const url = `${proxy}${NOTION_API_BASE}/${endpoint}`;
            
            // 顯示詳細的請求信息（但不記錄敏感數據）
            if (body) console.log(`請求類型: ${method}, 端點: ${endpoint}`);
                    
                    const headers = {
                        'Authorization': `Bearer ${token}`,
                        'Notion-Version': NOTION_VERSION,
                        'Content-Type': 'application/json'
                    };
                    
                    const options = {
                        method: method,
                        headers: headers
                    };
                    
                    if (body) {
                        options.body = JSON.stringify(body);
                    }
                    
                    // 設置請求超時
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);
                    options.signal = controller.signal;
                    
                    const response = await fetch(url, options);
                    clearTimeout(timeoutId);
                    
                    // 檢查回應狀態
                    if (!response.ok) {
                        let errorMessage = `HTTP錯誤 ${response.status}`;
                        try {
                            const errorData = await response.json();
                            console.error('API回應錯誤:', errorData);
                            
                            if (errorData.message) {
                                errorMessage = `Notion API錯誤: ${errorData.message}`;
                            }
                            
                            // 特定錯誤處理
                            if (response.status === 401) {
                                throw new Error('API密鑰無效或已過期。請檢查您的Notion Integration密鑰是否正確。');
                            } else if (response.status === 404) {
                                throw new Error('找不到資源。請確認資料庫ID是否正確。');
                            } else if (response.status === 403) {
                                throw new Error('權限不足。請確保您的Notion Integration已被授予訪問此資料庫的權限。');
                            } else if (response.status === 429) {
                                const retryAfter = response.headers.get('Retry-After') || 5;
                                console.warn(`達到API速率限制，${retryAfter}秒後重試`);
                                // 如果不是最後一次嘗試，等待後重試
                                if (attempts <= MAX_RETRIES) {
                                    await new Promise(r => setTimeout(r, retryAfter * 1000));
                                    continue; // 重試
                                }
                            }
                        } catch (parseError) {
                            console.error('無法解析API錯誤回應:', parseError);
                        }
                        throw new Error(errorMessage);
                    }
                    
                    // 成功回應，返回解析的JSON
                    try {
                        const data = await response.json();
                        console.log('API回應成功:', endpoint);
                        return data;
                    } catch (jsonError) {
                        console.warn('API回應不是有效的JSON:', jsonError);
                        return {}; // 返回空對象作為後備
                    }
                    
                } catch (error) {
            // 更詳細的錯誤分類和用戶友好提示
            if (error.name === 'AbortError') {
                throw new Error('請求超時。請檢查您的網絡連接或稍後再試。');
            }
            
            if (error.message.includes('Failed to fetch')) {
                throw new Error('網絡連接失敗。請檢查CORS代理設置或使用CORS瀏覽器擴充功能。');
            }
                    
                    // 如果已嘗試最大次數或不是應重試的錯誤，則拋出
                    if (attempts > MAX_RETRIES) {
                        throw error;
                    }
                    
                    // 其他錯誤重試前等待
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
            
            // 這裡不應該被執行到，如果到了這裡表示邏輯有問題
            throw new Error('請求失敗，已達到最大重試次數');
        }

        // 更新商家分類對照表以匹配Notion中的固定類別
        const categoryMap = {
            // 生活用品
            'SUPERMARKET': '生活用品', 'PARKNSHOP': '生活用品', 'WELLCOME': '生活用品',
            'WATSONS': '生活用品', 'MARKET': '生活用品',

            // 知識學習
            'BOOKSTORE': '知識學習', 'COURSE': '知識學習', 'EDUCATION': '知識學習',

            // 休閒娛樂
            'MOVIE': '休閒娛樂', 'CINEMA': '休閒娛樂', 'NETFLIX': '休閒娛樂',
            'SPOTIFY': '休閒娛樂', 'DISNEY': '休閒娛樂', 'GAME': '休閒娛樂',

            // 交通
            'UBER': '交通', 'TAXI': '交通', 'MTR': '交通', 'BUS': '交通',
            'TRANSPORT': '交通', 'OCTOPUS': '交通',

            // 健康醫療
            'DOCTOR': '健康醫療', 'CLINIC': '健康醫療', 'HOSPITAL': '健康醫療',
            'PHARMACY': '健康醫療', 'MEDICAL': '健康醫療',

            // 訂閱
            'SUBSCRIPTION': '訂閱', 'MAGAZINE': '訂閱', 'MEMBERSHIP': '訂閱',

            // 固定支出
            'RENT': '固定支出', 'MORTGAGE': '固定支出', 'LOAN': '固定支出',

            // 美妝
            'COSMETICS': '美妝', 'BEAUTY': '美妝', 'SKINCARE': '美妝',

            // 服飾配件
            'CLOTHING': '服飾配件', 'FASHION': '服飾配件', 'ACCESSORIES': '服飾配件',

            // 餐飲
            'CAFE': '餐飲', 'RESTAURANT': '餐飲', 'MCDONALDS': '餐飲',
            'STARBUCKS': '餐飲', 'FOOD': '餐飲', 'PIZZA': '餐飲',

            // 其他
            'OTHER': '其他'
        };

        // 根據商家名稱分類交易
        function categorizeTransaction(description) {
            try {
                if (!description) return '其他';
                
                description = description.toUpperCase();
                
                for (const [keyword, category] of Object.entries(categoryMap)) {
                    if (description.includes(keyword.toUpperCase())) {
                        return category;
                    }
                }
            } catch (error) {
                console.error("分類交易時出錯:", error);
            }
            
            return '其他'; // 預設類別
        }
        
        // 獲取類別的顏色
        function getCategoryColor(category) {
            try {
                const colorMap = {
                    '餐飲': 'bg-red-100 text-red-800',
                    '交通': 'bg-blue-100 text-blue-800',
                    '購物': 'bg-yellow-100 text-yellow-800',
                    '娛樂': 'bg-purple-100 text-purple-800',
                    '繳費': 'bg-green-100 text-green-800',
                    '健康': 'bg-indigo-100 text-indigo-800',
                    '生活用品': 'bg-yellow-100 text-yellow-800',
                    '知識學習': 'bg-indigo-100 text-indigo-800',
                    '休閒娛樂': 'bg-purple-100 text-purple-800',
                    '健康醫療': 'bg-green-100 text-green-800',
                    '訂閱': 'bg-blue-100 text-blue-800',
                    '固定支出': 'bg-gray-100 text-gray-800',
                    '美妝': 'bg-pink-100 text-pink-800',
                    '服飾配件': 'bg-purple-100 text-purple-800',
                    '其他': 'bg-gray-100 text-gray-800'
                };
                
                return colorMap[category] || 'bg-gray-100 text-gray-800';
            } catch (error) {
                console.error("獲取類別顏色時出錯:", error);
                return 'bg-gray-100 text-gray-800';
            }
        }

        // 用於存儲解析的交易資料
        let transactions = [];

        // 設置頁面的事件處理程序
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const uploadButton = document.getElementById('upload-button');
                const pdfUpload = document.getElementById('pdf-upload');
                const backToUpload = document.getElementById('back-to-upload');
                const proceedToSubmit = document.getElementById('proceed-to-submit');
                const newUpload = document.getElementById('new-upload');
                const imageUploadButton = document.getElementById('image-upload-button');
                const dropZone = document.getElementById('drop-zone');
                const closeError = document.getElementById('close-error');
                const closeSuccess = document.getElementById('close-success');
                const testConnection = document.getElementById('test-connection');
                
                // 關閉錯誤訊息
                closeError.addEventListener('click', function() {
                    document.getElementById('error-alert').classList.add('hidden');
                });
                
                // 關閉成功訊息
                closeSuccess.addEventListener('click', function() {
                    document.getElementById('success-alert').classList.add('hidden');
                });
                
                // 測試連接按鈕
                testConnection.addEventListener('click', async function() {
                    try {
                        const notionToken = document.getElementById('notion-token').value.trim();
                        const databaseId = document.getElementById('database-id').value.trim();
                
                        if (!notionToken) {
                            showError('請輸入 Notion API 密鑰');
                            return;
                        }
                
                        if (!databaseId) {
                            showError('請輸入 Notion 資料庫 ID');
                            return;
                        }
                
                        showLoading(true, '測試連接中...');
                        const result = await diagnoseNotionConnection(notionToken, databaseId);
                
                        if (result.success) {
                            showSuccess('連接成功', result.message);
                        } else {
                            showError('連接失敗', result.error);
                        }
                    } catch (error) {
                        console.error("測試連接時出錯:", error);
                        showError('測試連接時出錯', error.message);
                    } finally {
                        showLoading(false);
                    }
                });
                
                // 上傳按鈕點擊事件
                uploadButton.addEventListener('click', function() {
                    pdfUpload.click();
                });
                
                // 檔案選擇事件
                pdfUpload.addEventListener('change', function(e) {
                    try {
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            if (!file || file.type !== 'application/pdf') {
                                showError('檔案類型錯誤', '請上傳有效的 PDF 檔案！');
                                return;
                            }
                            showLoading(true, '正在解析 PDF 檔案...');
                            
                            // 設置處理超時
                            resetProcessingTimeout(() => {
                                showLoading(false);
                                showError('處理 PDF 超時', '處理時間過長，請嘗試上傳較小的檔案或使用圖片上傳方式。');
                            });
                            
                            processPDF(file);
                        }
                    } catch (error) {
                        console.error("處理檔案選擇時出錯:", error);
                        showLoading(false);
                        showError('處理檔案時出錯', error.message);
                    }
                });
                
                // 圖片上傳按鈕點擊事件
                imageUploadButton.addEventListener('click', () => {
                    try {
                        const imageUploadInput = document.createElement('input');
                        imageUploadInput.type = 'file';
                        imageUploadInput.accept = 'image/*';
                        imageUploadInput.addEventListener('change', (e) => {
                            try {
                                if (e.target.files.length > 0) {
                                    const file = e.target.files[0];
                                    showLoading(true, '正在處理圖片...');
                                    
                                    // 設置處理超時
                                    resetProcessingTimeout(() => {
                                        showLoading(false);
                                        showError('處理圖片超時', '處理時間過長，請嘗試上傳較小的圖片或使用PDF上傳方式。');
                                    });
                                    
                                    processImage(file);
                                }
                            } catch (error) {
                                console.error("處理圖片選擇時出錯:", error);
                                showLoading(false);
                                showError('處理圖片時出錯', error.message);
                            }
                        });
                        imageUploadInput.click();
                    } catch (error) {
                        console.error("創建圖片上傳輸入框時出錯:", error);
                        showError('創建圖片上傳時出錯', error.message);
                    }
                });
                
                // 返回按鈕點擊事件
                backToUpload.addEventListener('click', function() {
                    try {
                        showSection('upload-section');
                        setActiveStep(1);
                    } catch (error) {
                        console.error("返回上傳頁面時出錯:", error);
                        showError('返回上傳頁面時出錯', error.message);
                    }
                });
                
                // 送出按鈕點擊事件
                proceedToSubmit.addEventListener('click', function() {
                    try {
                        // 驗證 Notion API 密鑰和資料庫 ID
                        const notionToken = document.getElementById('notion-token').value.trim();
                        const databaseId = document.getElementById('database-id').value.trim();
                        
                        if (!notionToken) {
                            showError('請輸入 Notion API 密鑰');
                            document.getElementById('notion-token').focus();
                            return;
                        }
                        
                        if (!databaseId) {
                            showError('請輸入 Notion 資料庫 ID');
                            document.getElementById('database-id').focus();
                            return;
                        }
                        
                        // 檢查API密鑰格式
                        if (!notionToken.startsWith('secret_')) {
                            showError('Notion API 密鑰格式錯誤', '應以 secret_ 開頭');
                            document.getElementById('notion-token').focus();
                            return;
                        }
                        
                        showLoading(true, '正在連接 Notion API...');
                        
                        // 設置處理超時
                        resetProcessingTimeout(() => {
                            showLoading(false);
                            showError('連接 Notion API 超時', '請檢查您的網絡連接或稍後再試。');
                        });
                        
                        submitToNotion();
                    } catch (error) {
                        console.error("處理提交時出錯:", error);
                        showLoading(false);
                        showError('處理提交時出錯', error.message);
                    }
                });
                
                // 上傳新檔案按鈕點擊事件
                newUpload.addEventListener('click', function() {
                    try {
                        // 清除之前的資料，包括 API 密鑰和資料庫 ID
                        pdfUpload.value = '';
                        document.getElementById('notion-token').value = '';
                        document.getElementById('database-id').value = '';
                        transactions = [];
                        
                        showSection('upload-section');
                        setActiveStep(1);
                    } catch (error) {
                        console.error("返回上傳新檔案時出錯:", error);
                        showError('返回上傳頁面時出錯', error.message);
                    }
                });
                
                // 拖放支持
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-blue-500');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('border-blue-500');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    try {
                        e.preventDefault();
                        dropZone.classList.remove('border-blue-500');
                        
                        if (e.dataTransfer.files.length > 0) {
                            const file = e.dataTransfer.files[0];
                            if (file.type === 'application/pdf') {
                                showLoading(true, '正在解析 PDF 檔案...');
                                
                                // 設置處理超時
                                resetProcessingTimeout(() => {
                                    showLoading(false);
                                    showError('處理 PDF 超時', '處理時間過長，請嘗試上傳較小的檔案或使用圖片上傳方式。');
                                });
                                
                                processPDF(file);
                            } else if (file.type.startsWith('image/')) {
                                showLoading(true, '正在處理圖片...');
                                
                                // 設置處理超時
                                resetProcessingTimeout(() => {
                                    showLoading(false);
                                    showError('處理圖片超時', '處理時間過長，請嘗試上傳較小的圖片或使用PDF上傳方式。');
                                });
                                
                                processImage(file);
                            } else {
                                showError('檔案類型錯誤', '請上傳PDF檔案或圖片檔案');
                            }
                        }
                    } catch (error) {
                        console.error("處理拖放時出錯:", error);
                        showLoading(false);
                        showError('處理拖放時出錯', error.message);
                    }
                });

                // 自動生成隨機測試資料按鈕
                const testDataButton = document.getElementById('generate-test-data');
                if (testDataButton) {
                    testDataButton.addEventListener('click', function() {
                        generateTestTransactions();
                    });
                }
                
                // 增加一個連接問題診斷按鈕
                const helpButton = document.getElementById('connection-help');
                if (helpButton) {
                    helpButton.addEventListener('click', function() {
                        showConnectionTroubleshooting();
                    });
                }
            } catch (error) {
                console.error("設置事件處理程序時出錯:", error);
                showError('初始化頁面時出錯', error.message);
            }
        });

        // 設置處理超時
        function resetProcessingTimeout(callback) {
            try {
                // 清除之前的超時
                if (processingTimeoutId !== null) {
                    clearTimeout(processingTimeoutId);
                }
                
                // 設置新的超時
                processingTimeoutId = setTimeout(() => {
                    processingTimeoutId = null;
                    if (callback) callback();
                }, PROCESSING_TIMEOUT);
            } catch (error) {
                console.error("設置處理超時時出錯:", error);
            }
        }
        
        // 清除處理超時
        function clearProcessingTimeout() {
            try {
                if (processingTimeoutId !== null) {
                    clearTimeout(processingTimeoutId);
                    processingTimeoutId = null;
                }
            } catch (error) {
                console.error("清除處理超時時出錯:", error);
            }
        }

        // 設置活動步驟
        function setActiveStep(stepNumber) {
            try {
                document.querySelectorAll('.step').forEach((step, index) => {
                    if (index + 1 === stepNumber) {
                        step.classList.remove('text-gray-400', 'border-gray-200');
                        step.classList.add('text-blue-600', 'border-blue-600');
                    } else if (index + 1 < stepNumber) {
                        step.classList.remove('text-blue-600', 'border-blue-600', 'text-gray-400', 'border-gray-200');
                        step.classList.add('text-gray-600', 'border-gray-400');
                    } else {
                        step.classList.remove('text-blue-600', 'border-blue-600', 'text-gray-600', 'border-gray-400');
                        step.classList.add('text-gray-400', 'border-gray-200');
                    }
                });
            } catch (error) {
                console.error("設置活動步驟時出錯:", error);
            }
        }

// 改進 showLoading 函數
function showLoading(show, text = '處理中，請稍候...') {
    try {
        const loading = document.getElementById('loading');
        if (!loading) {
            console.warn('無法找到loading元素');
            return;
        }
        
        const loadingText = loading.querySelector('.loading-text');
        if (!loadingText) {
            console.warn('無法找到loading-text元素');
        } else {
            loadingText.textContent = text;
        }
        
        if (show) {
            loading.style.display = 'flex';
        } else {
            loading.style.display = 'none';
            clearProcessingTimeout();
        }
    } catch (error) {
        console.error("顯示/隱藏載入指示器時出錯:", error);
    }
}

        // 顯示指定區域，隱藏其他區域
        function showSection(sectionId) {
            try {
                const sections = ['upload-section', 'preview-section', 'result-section'];
                sections.forEach(id => {
                    const section = document.getElementById(id);
                    if (id === sectionId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("顯示區域時出錯:", error);
            }
        }

        // 處理PDF檔案
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                // 提取文本內容
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                console.log('從PDF提取的文本:', fullText);
                
                // 提取交易資料
                extractTransactions(fullText);
                
                // 如果沒有提取到交易，顯示提示
                if (transactions.length === 0) {
                    showError('未能提取交易數據', '未能從PDF中提取到任何交易資料。請確保PDF格式正確。');
                    showLoading(false);
                    return;
                }
                
                // 清空先前可能存在的敏感資料
                document.getElementById('notion-token').value = '';
                document.getElementById('database-id').value = '';
                
                // 顯示預覽
                populateTransactionsPreview();
                showSection('preview-section');
                setActiveStep(2);
                
            } catch (error) {
                console.error('處理 PDF 時出錯:', error);
                showError('處理 PDF 時出錯', error.message);
            } finally {
                clearProcessingTimeout();
                showLoading(false); // 確保無論成功或失敗都隱藏 loading
            }
        }

        // 新增圖片上傳與解析功能
        function processImage(file) {
            try {
                Tesseract.recognize(
                    file, // 圖片文件
                    'eng+chi_tra', // 語言設置，同時支持英文和繁體中文
                    {
                        logger: info => {
                            console.log(info);
                            if (info.status === 'recognizing text') {
                                showLoading(true, `OCR識別中: ${Math.round(info.progress * 100)}%`);
                            }
                        }
                    }
                ).then(({ data: { text } }) => {
                    console.log('OCR 提取的文字:', text);
                    extractTransactions(text); // 使用現有的交易提取邏輯
                    
                    // 如果沒有提取到交易，顯示提示
                    if (transactions.length === 0) {
                        showError('未能提取交易數據', '未能從圖片中提取到任何交易資料。請確保圖片清晰且包含交易資訊。');
                        showLoading(false);
                        return;
                    }
                    
                    // 清空先前可能存在的敏感資料
                    document.getElementById('notion-token').value = '';
                    document.getElementById('database-id').value = '';
                    
                    populateTransactionsPreview(); // 填充預覽表格
                    showSection('preview-section');
                    setActiveStep(2);
                }).catch(error => {
                    console.error('處理圖片時出錯:', error);
                    showError('處理圖片時出錯', error.message);
                }).finally(() => {
                    clearProcessingTimeout();
                    showLoading(false);
                });
            } catch (error) {
                console.error('處理圖片時出錯:', error);
                showError('處理圖片時出錯', error.message);
                showLoading(false);
            }
        }

        // 更新交易解析邏輯以提取所需的欄位
        function extractTransactions(text) {
            try {
                console.log('提取的文字:', text); // 加入日誌
                
                // 清空之前的交易記錄
                transactions = [];
                
                // 優化正則表達式，增加對不同格式的支持
                // 1. 標準格式：日期 日期 描述 金額
                const standardRegex = /(\d{1,2} [A-Z]{3} \d{4})\s+(\d{1,2} [A-Z]{3} \d{4})\s+([^\n]+?)\s+([\d,.]+(?:-)?)\s*$/gm;
                
                // 2. 替代格式：日期（可能有時間） 描述 金額（可能有貨幣符號）
                const altRegex = /(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})(?:\s+\d{1,2}:\d{2})?\s+([^\n\$]+?)\s+\$?\s*([\d,.]+)/gm;
                
                // 處理標準格式
                let match;
                while ((match = standardRegex.exec(text)) !== null) {
                    console.log('匹配到的標準格式交易:', match); // 加入日誌
                    
                    // 提取日期、描述和金額
                    const transactionDate = match[1]; // 第一個日期
                    const postingDate = match[2];     // 第二個日期
                    const description = match[3].trim();
                    const amountStr = match[4].replace(/,/g, '');
                    const amount = parseFloat(amountStr);
                    
                    if (!isNaN(amount) && description) {
                        // 根據商家名稱分類交易
                        const category = categorizeTransaction(description);
                        
                        // 將交易添加到陣列
                        transactions.push({
                            name: description,
                            amount: amount,
                            date: transactionDate,
                            category: category,
                            note: '',
                            paymentMethod: '信用卡'
                        });
                    }
                }
                
                // 如果標準格式沒有匹配到交易，嘗試替代格式
                if (transactions.length === 0) {
                    while ((match = altRegex.exec(text)) !== null) {
                        console.log('匹配到的替代格式交易:', match); // 加入日誌
                        
                        // 提取日期、描述和金額
                        const transactionDate = match[1]; // 日期
                        const description = match[2].trim();
                        const amountStr = match[3].replace(/,/g, '');
                        const amount = parseFloat(amountStr);
                        
                        if (!isNaN(amount) && description) {
                            // 根據商家名稱分類交易
                            const category = categorizeTransaction(description);
                            
                            // 將交易添加到陣列
                            transactions.push({
                                name: description,
                                amount: amount,
                                date: transactionDate,
                                category: category,
                                note: '',
                                paymentMethod: '信用卡'
                            });
                        }
                    }
                }
                
                // 如果還是沒有找到交易，嘗試更寬鬆的匹配
                if (transactions.length === 0) {
                    // 尋找任何可能的交易行
                    const looseRegex = /(.{10,50})\s+(\d+\.\d{2})/g;
                    while ((match = looseRegex.exec(text)) !== null) {
                        console.log('寬鬆匹配到的可能交易:', match);
                        const description = match[1].trim();
                        const amountStr = match[2].replace(/,/g, '');
                        const amount = parseFloat(amountStr);
                        
                        if (!isNaN(amount) && description && !description.match(/^\d+$/)) {
                            const category = categorizeTransaction(description);
                            const today = new Date();
                            const transactionDate = `${today.getDate()} ${['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'][today.getMonth()]} ${today.getFullYear()}`;
                            
                            transactions.push({
                                name: description,
                                amount: amount,
                                date: transactionDate,
                                category: category,
                                note: '自動識別，請確認',
                                paymentMethod: '信用卡'
                            });
                        }
                    }
                }
                
                console.log('提取的交易資料:', transactions);
            } catch (error) {
                console.error("提取交易資料時出錯:", error);
                showError('提取交易資料時出錯', error.message);
            }
        }

        // 格式化日期以符合Notion的要求
                // 在 createNotionPage 函數中修改日期格式
                function formatDateForNotion(dateStr) {
            try {
                // 處理格式如 "15 MAR 2023"
                if (dateStr.match(/\d{1,2} [A-Z]{3} \d{4}/)) {
                    const parts = dateStr.split(' ');
                    const day = parseInt(parts[0]);
                    const monthMap = {
                        'JAN': 0, 'FEB': 1, 'MAR': 2, 'APR': 3, 'MAY': 4, 'JUN': 5,
                        'JUL': 6, 'AUG': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DEC': 11
                    };
                    const month = monthMap[parts[1]];
                    const year = parseInt(parts[2]);
                    
                    if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                        const date = new Date(year, month, day);
                        return date.toISOString().split('T')[0]; // 返回 YYYY-MM-DD 格式
                    }
                }
                
                // 處理格式如 "15/03/2023" 或 "15-03-2023"
                if (dateStr.match(/\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}/)) {
                    const cleanDate = dateStr.replace(/[\/\-\.]/g, '/');
                    const parts = cleanDate.split('/');
                    
                    // 假設格式為 DD/MM/YYYY
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // 月份從0開始
                    let year = parseInt(parts[2]);
                    
                    // 處理兩位數年份
                    if (year < 100) {
                        year += year < 50 ? 2000 : 1900;
                    }
                    
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                        const date = new Date(year, month, day);
                        return date.toISOString().split('T')[0]; // 返回 YYYY-MM-DD 格式
                    }
                }
                
                // 如果無法解析，返回今天的日期
                console.warn('無法解析日期:', dateStr, '使用今天的日期');
                return new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error('格式化日期時出錯:', error);
                return new Date().toISOString().split('T')[0]; // 返回今天的日期作為後備
            }
        }

        // 更新預覽表格以顯示新欄位
        function populateTransactionsPreview() {
            try {
                const tbody = document.getElementById('transactions-preview');
                tbody.innerHTML = '';

                transactions.forEach((transaction, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                    // 名稱
                    const nameCell = document.createElement('td');
                    nameCell.className = 'px-3 py-2 text-sm';
                    nameCell.textContent = transaction.name;
                    row.appendChild(nameCell);

                    // 金額
                    const amountCell = document.createElement('td');
                    amountCell.className = 'px-3 py-2 text-sm';
                    amountCell.textContent = transaction.amount.toFixed(2);
                    row.appendChild(amountCell);

                    // 日期
                    const dateCell = document.createElement('td');
                    dateCell.className = 'px-3 py-2 text-sm';
                    dateCell.textContent = transaction.date;
                    row.appendChild(dateCell);

                    // 類別
                    const categoryCell = document.createElement('td');
                    categoryCell.className = 'px-3 py-2 text-sm';
                    
                    const categorySpan = document.createElement('span');
                    categorySpan.className = 'category-badge ' + getCategoryColor(transaction.category);
                    categorySpan.textContent = transaction.category;
                    
                    categoryCell.appendChild(categorySpan);
                    row.appendChild(categoryCell);

                    // 備註
                    const noteCell = document.createElement('td');
                    noteCell.className = 'px-3 py-2 text-sm';
                    
                    const noteInput = document.createElement('input');
                    noteInput.type = 'text';
                    noteInput.className = 'border rounded px-2 py-1 w-full';
                    noteInput.value = transaction.note;
                    noteInput.addEventListener('input', (e) => {
                        transactions[index].note = e.target.value;
                    });
                    
                    noteCell.appendChild(noteInput);
                    row.appendChild(noteCell);

                    // 付款方式
                    const paymentMethodCell = document.createElement('td');
                    paymentMethodCell.className = 'px-3 py-2 text-sm';
                    
                    const paymentMethodSelect = document.createElement('select');
                    paymentMethodSelect.className = 'border rounded px-2 py-1 w-full';
                    
                    ['信用卡', '現金', '轉帳'].forEach((method) => {
                        const option = document.createElement('option');
                        option.value = method;
                        option.textContent = method;
                        if (method === transaction.paymentMethod) {
                            option.selected = true;
                        }
                        paymentMethodSelect.appendChild(option);
                    });
                    
                    paymentMethodSelect.addEventListener('change', (e) => {
                        transactions[index].paymentMethod = e.target.value;
                    });
                    
                    paymentMethodCell.appendChild(paymentMethodSelect);
                    row.appendChild(paymentMethodCell);

                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("填充交易預覽時出錯:", error);
                showError('顯示交易預覽時出錯', error.message);
            }
        }

        // 直接調用NotionAPI的函數
        async function callNotionAPI(endpoint, method, token, body = null) {
            try {
                const proxy = await getWorkingProxy();
                const url = `${proxy}${NOTION_API_BASE}/${endpoint}`;
                
                console.log(`API請求: ${method} ${url}`);
                
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Notion-Version': NOTION_VERSION,
                    'Content-Type': 'application/json'
                };
                
                const options = {
                    method: method,
                    headers: headers
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30秒超時
                options.signal = controller.signal;
                
                try {
                    const response = await fetch(url, options);
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `API請求失敗：${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('請求超時，請檢查您的網絡連接或稍後再試');
                    }
                    throw error;
                }
            } catch (error) {
                console.error('API調用錯誤:', error);
                throw error;
            }
        }
        
        // 修改 createNotionPage 函數中的日期部分
        async function createNotionPage(token, databaseId, transaction) {
            try {
                const formattedDate = formatDateForNotion(transaction.date);
                
                const pageData = {
                    parent: { database_id: databaseId },
                    properties: {
                        名稱: { title: [{ text: { content: transaction.name } }] },
                        金額: { number: transaction.amount },
                        日期: { date: { start: formattedDate } }, // 使用格式化的日期
                        類別: { select: { name: transaction.category } },
                        備註: { rich_text: [{ text: { content: transaction.note || '' } }] },
                        付款方式: { select: { name: transaction.paymentMethod } },
                    }
                };
                
                return await callNotionAPI('pages', 'POST', token, pageData);
            } catch (error) {
                console.error('創建Notion頁面時出錯:', error);
                throw error;
            }
        }

        // 添加此函數到您的代碼中
        async function diagnoseApiError(error, token, dbId) {
            console.log("正在診斷API錯誤...");
            let diagnosisResult = "未知錯誤";
            
            // 檢查常見錯誤
            if (error.message.includes("unauthorized") || error.message.includes("401") || error.message.includes("無效")) {
                diagnosisResult = "API密鑰無效或過期。請確認密鑰格式正確且有效。";
                
                // 嘗試用更簡單的請求測試API密鑰
                try {
                    await fetch("https://api.notion.com/v1/users/me", {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Notion-Version': NOTION_VERSION
                        }
                    });
                } catch (e) {
                    diagnosisResult += "\n無法連接到Notion API。請檢查網絡連接。";
                }
            } else if (error.message.includes("not found") || error.message.includes("404")) {
                diagnosisResult = "找不到指定的資料庫。請確認資料庫ID正確。";
            } else if (error.message.includes("permission") || error.message.includes("403")) {
                diagnosisResult = "權限不足。請確保您的Notion Integration已被授予訪問此資料庫的權限。";
            } else if (error.message.includes("structure") || error.message.includes("欄位")) {
                diagnosisResult = "資料庫結構不符合要求。請確保資料庫包含所需的欄位和正確的欄位類型。";
            }
            
            console.log("診斷結果:", diagnosisResult);
            return diagnosisResult;
        }

        // 送出資料至 Notion
        // 送出資料至 Notion - 改進錯誤處理與進度顯示
        async function submitToNotion() {
    try {
        const notionToken = document.getElementById('notion-token').value.trim();
        const databaseId = document.getElementById('database-id').value.trim();
                
                // 再次驗證輸入
                if (!notionToken || !databaseId) {
                    showError('缺少必要資訊', '請輸入Notion API密鑰和資料庫ID');
                    showLoading(false);
                    return;
                }
                
                // 初始化結果區域
                const resultContent = document.getElementById('result-content');
                resultContent.innerHTML = `
                    <div class="p-4 bg-blue-100 text-blue-800 rounded-lg">
                        <p>正在處理交易資料，請稍候...</p>
                        <div class="mt-2 bg-blue-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="progress-text">準備中...</p>
                        <p id="current-operation" class="text-sm mt-2">檢查API連接...</p>
                    </div>
                `;
                
                showSection('result-section');
                setActiveStep(3);
                
                // 診斷連接
                document.getElementById('current-operation').textContent = '驗證Notion API連接...';
                const dbCheckResult = await diagnoseNotionConnection(notionToken, databaseId);
                
// 在診斷完成後添加具體的操作建議
if (!dbCheckResult.success) {
    let actionSuggestion = "";
    
    if (dbCheckResult.error.includes("API密鑰無效")) {
        actionSuggestion = `
            <div class="mt-2 p-2 bg-blue-50 rounded">
                <p class="font-bold">操作建議：</p>
                <ol class="list-decimal ml-5">
                    <li>在 <a href="https://www.notion.so/my-integrations" target="_blank" class="text-blue-600 underline">Notion整合設置頁面</a> 檢查或創建新的API密鑰</li>
                    <li>確保密鑰以 "secret_" 開頭</li>
                    <li>複製完整的密鑰，不要有多餘空格</li>
                </ol>
            </div>
        `;
    } else if (dbCheckResult.error.includes("找不到資料庫")) {
        // 其他問題的具體指引...
    }
    
    // 將操作建議添加到錯誤信息中
    resultContent.innerHTML += actionSuggestion;
}
                
                // 更新進度顯示
                document.getElementById('progress-text').textContent = `0/${transactions.length} 筆交易已處理`;
                
                // 處理統計
                let successCount = 0;
                let failCount = 0;
                let errors = [];
                
// 逐個處理交易 - 添加間隔防止API限流
for (let i = 0; i < transactions.length; i++) {
    const transaction = transactions[i];
    const progressPercent = Math.round(((i) / transactions.length) * 100);
    document.getElementById('progress-bar').style.width = `${progressPercent}%`;
    document.getElementById('current-operation').textContent = 
        `處理交易: ${transaction.name.substring(0, 30)}${transaction.name.length > 30 ? '...' : ''}`;
    
    try {
        showLoading(true, `處理交易 ${i+1}/${transactions.length}...`);
        
        await createNotionPage(notionToken, databaseId, transaction);
        successCount++;
        
        // 更新進度文本
        document.getElementById('progress-text').textContent = 
            `${i+1}/${transactions.length} 筆交易已處理 (成功: ${successCount}, 失敗: ${failCount})`;
            
        // 添加短暫延遲，防止API限流
        if (i < transactions.length - 1) {
            await new Promise(r => setTimeout(r, 500)); // 每次請求間隔500毫秒
        }
    } catch (error) {
                        failCount++;
                        errors.push({
                            transaction: transaction.name,
                            error: error.message
                        });
                        
                        // 更新進度文本，包含失敗計數
                        document.getElementById('progress-text').textContent = 
                            `${i+1}/${transactions.length} 筆交易已處理 (成功: ${successCount}, 失敗: ${failCount})`;
                        
                        console.error(`處理交易失敗: ${transaction.name}`, error);
                    }
                    
                    // 更新最終進度
                    const finalProgressPercent = Math.round(((i + 1) / transactions.length) * 100);
                    document.getElementById('progress-bar').style.width = `${finalProgressPercent}%`;
                }
                
                // 顯示最終結果
                let resultColor = successCount > 0 ? 
                                  (failCount > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800') : 
                                  'bg-red-100 text-red-800';
                
                resultContent.innerHTML = `
                    <div class="p-4 ${resultColor} rounded-lg">
                        <p class="text-lg font-bold mb-2">處理完成！</p>
                        <div class="flex items-center mb-2">
                            <div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div>
                            <p>成功: ${successCount} 筆</p>
                        </div>
                        <div class="flex items-center mb-4">
                            <div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div>
                            <p>失敗: ${failCount} 筆</p>
                        </div>
                        ${failCount > 0 ? `
                        <div class="mt-4 p-3 bg-white rounded-lg shadow-inner">
                            <p class="font-bold">失敗詳情:</p>
                            <div class="max-h-40 overflow-y-auto">
                                <ul class="list-disc pl-5">
                                    ${errors.map(e => `<li class="text-sm py-1"><span class="font-semibold">${e.transaction}</span>: ${e.error}</li>`).join('')}
                                </ul>
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 text-blue-800 rounded-lg">
                        <p class="text-sm">為了保障您的資料安全，API 密鑰和資料庫 ID 不會被儲存。下次使用時需要重新輸入。</p>
                    </div>
                `;
                
                // 清空敏感資料
                document.getElementById('notion-token').value = '';
                document.getElementById('database-id').value = '';
                
            } catch (error) {
                console.error('送出資料至 Notion 時出錯:', error);
                
                // 調用診斷函數
                const diagnosis = await diagnoseApiError(error, notionToken, databaseId);
                
                const resultContent = document.getElementById('result-content');
                resultContent.innerHTML = `
                    <div class="p-4 bg-red-100 text-red-800 rounded-lg">
                        <div class="flex items-center mb-3">
                            <svg class="h-6 w-6 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="font-bold">處理交易時出錯:</p>
                        </div>
                        <div class="mt-2 p-3 bg-white rounded-lg shadow-inner">
                            <p class="whitespace-pre-line">${error.message}</p>
                        </div>
                        <div class="mt-3 p-2 bg-yellow-50 text-yellow-800 rounded">
                            <p class="font-bold">問題診斷:</p>
                            <p class="whitespace-pre-line">${diagnosis}</p>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 text-yellow-800 rounded-lg">
                        <p class="text-sm font-bold">常見問題排解:</p>
                        <ul class="list-disc pl-5 text-sm space-y-1 mt-2">
                            <li>確保您的 Notion API 金鑰格式正確 (以 <code>secret_</code> 開頭)</li>
                            <li>確認資料庫 ID 是否正確 (在 Notion 中分享資料庫時可以查看)</li>
                            <li>確認您的 Notion Integration 是否已被授予訪問此資料庫的權限</li>
                            <li>檢查資料庫是否包含所需的欄位: 名稱、金額、日期、類別、備註、付款方式</li>
                            <li>如遇到 CORS 問題，請嘗試以下操作:
                                <ul class="list-disc pl-5 text-sm mt-1">
                                    <li>在「CORS代理URL」欄位中提供自定義代理</li>
                                    <li>使用瀏覽器擴充功能暫時禁用CORS（如：<a href="https://chrome.google.com/webstore/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank" class="underline">CORS Unblock</a>）</li>
                                    <li>創建並部署自己的CORS代理（如Cloudflare Worker）</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                `;
            } finally {
                clearProcessingTimeout();
                showLoading(false); // 確保無論成功或失敗都隱藏 loading
            }
        }

        // 顯示連接故障排除指南
        function showConnectionTroubleshooting() {
            const helpDialog = document.createElement('div');
            helpDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
            helpDialog.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg max-w-xl w-full max-h-4/5 overflow-y-auto m-4">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold">連接問題排解指南</h2>
                        <button id="close-help" class="text-gray-500 hover:text-gray-700">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-4">
                        <div class="mb-4">
                            <h3 class="font-bold text-blue-600 mb-2">API 密鑰問題</h3>
                            <ul class="list-disc ml-5 space-y-1">
                                <li>確保API密鑰以 <code>secret_</code> 開頭</li>
                                <li>確認密鑰沒有多餘的空格</li>
                                <li>檢查是否為正確的Integration密鑰（而非其他API Token）</li>
                            </ul>
                        </div>
                        <div class="mb-4">
                            <h3 class="font-bold text-blue-600 mb-2">資料庫 ID 問題</h3>
                            <ul class="list-disc ml-5 space-y-1">
                                <li>資料庫ID應為 32 個字符的字串，帶有連字符</li>
                                <li>可以從資料庫URL獲取，格式通常為:<br>
                                    <code class="text-xs bg-gray-100 p-1 rounded">https://www.notion.so/.../{Database ID}?v=...</code>
                                </li>
                                <li>確認資料庫ID沒有包含額外參數如 <code>?v=...</code></li>
                            </ul>
                        </div>
                        <div class="mb-4">
                            <h3 class="font-bold text-blue-600 mb-2">權限問題</h3>
                            <ol class="list-decimal ml-5 space-y-2">
                                <li>在 <a href="https://www.notion.so/my-integrations" target="_blank" class="text-blue-600 underline">Notion的整合頁面</a> 檢查你的Integration設置</li>
                                <li>確保Integration已被授予資料庫的訪問權限:
                                    <ul class="list-disc ml-5 mt-1">
                                        <li>在Notion中打開資料庫</li>
                                        <li>點擊右上角的「分享」按鈕</li>
                                        <li>輸入你的Integration名稱並邀請</li>
                                    </ul>
                                </li>
                                <li>確保Integration有足夠的權限（讀寫權限）</li>
                            </ol>
                        </div>
                        <div class="mb-4">
                            <h3 class="font-bold text-blue-600 mb-2">CORS 問題</h3>
                            <ul class="list-disc ml-5 space-y-1">
                                <li>在「CORS代理URL」中輸入自定義代理</li>
                                <li>安裝瀏覽器擴充如 <a href="https://chrome.google.com/webstore/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank" class="text-blue-600 underline">CORS Unblock</a></li>
                                <li>使用自己的Cloudflare Worker作為代理（附簡易代碼）:
                                    <pre class="bg-gray-100 p-2 mt-1 overflow-x-auto text-xs rounded"><code>addEventListener('fetch', event => {
      event.respondWith(handleRequest(event.request))
    })
    
    async function handleRequest(request) {
      const url = new URL(request.url)
      let apiUrl = url.searchParams.get('apiurl')
      
      if (!apiUrl) {
        return new Response('Missing apiurl parameter', { status: 400 })
      }
      
      const modifiedRequest = new Request(apiUrl, {
        method: request.method,
        headers: request.headers,
        body: request.body
      })
      
      const response = await fetch(modifiedRequest)
      const modifiedResponse = new Response(response.body, response)
      
      // 添加CORS頭
      modifiedResponse.headers.set('Access-Control-Allow-Origin', '*')
      modifiedResponse.headers.set('Access-Control-Allow-Methods', 
        'GET, POST, PUT, DELETE, PATCH, OPTIONS')
      modifiedResponse.headers.set('Access-Control-Allow-Headers', 
        'Content-Type, Authorization, Notion-Version')
      
      return modifiedResponse
    }</code></pre>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 bg-gray-50">
                        <button id="close-help-btn" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            明白了
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpDialog);
            
            document.getElementById('close-help').addEventListener('click', () => {
                document.body.removeChild(helpDialog);
            });
            
            document.getElementById('close-help-btn').addEventListener('click', () => {
                document.body.removeChild(helpDialog);
            });
        }
    </script>
</body>
</html>
