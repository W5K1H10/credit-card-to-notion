<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>信用卡月結單至Notion</title>
    <!-- 使用 PDF.js 庫來解析PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- 使用 Tailwind CSS 簡化樣式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 4px;
            white-space: nowrap;
        }
        .input-required::after {
            content: "*";
            color: red;
            margin-left: 2px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>

    <header class="bg-blue-600 text-white p-4 shadow">
        <h1 class="text-xl font-bold">信用卡月結單至Notion</h1>
    </header>

    <main class="container mx-auto p-4">
        <!-- 步驟導覽 -->
        <div class="steps mb-6">
            <div class="flex justify-between">
                <div id="step1" class="step flex-1 text-center font-semibold text-blue-600 border-b-2 border-blue-600 pb-2">上傳PDF</div>
                <div id="step2" class="step flex-1 text-center font-semibold text-gray-400 border-b-2 border-gray-200 pb-2">預覽資料</div>
                <div id="step3" class="step flex-1 text-center font-semibold text-gray-400 border-b-2 border-gray-200 pb-2">送出至Notion</div>
            </div>
        </div>

        <!-- 步驟1：上傳區域 -->
        <section id="upload-section" class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="text-lg font-semibold mb-4">上傳信用卡月結單</h2>
            
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mt-1 text-sm text-gray-600">
                    點擊上傳或拖放PDF檔案
                </p>
                <input id="pdf-upload" type="file" accept="application/pdf" class="hidden">
                <button id="upload-button" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    選擇檔案
                </button>
                <button id="image-upload-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    上傳圖片
                </button>
            </div>
        </section>

        <!-- 步驟2：交易預覽 -->
        <section id="preview-section" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">交易資料預覽</h2>
            
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-semibold text-yellow-800">Notion 連接設定</h3>
                <p class="text-sm text-yellow-700 mb-2">為保障安全性，每次上傳都需要輸入您的 Notion API 密鑰和資料庫 ID。您的密鑰不會被儲存或傳送到任何第三方服務。</p>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 input-required">Notion API 密鑰</label>
                    <input type="password" id="notion-token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="secret_xxxxxxxxxxx" required>
                    <p class="text-xs text-gray-500 mt-1">這個密鑰不會被儲存，僅用於本次上傳</p>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 input-required">Notion 資料庫 ID</label>
                    <input type="text" id="database-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" required>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700">CORS 代理 URL (選填)</label>
                    <input type="text" id="cors-proxy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="https://your-cors-proxy.workers.dev">
                    <p class="text-xs text-gray-500 mt-1">若您有自己的CORS代理，可在此填入。若留空，將使用預設代理</p>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">交易日期</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類別</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">付款方式</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-preview" class="bg-white divide-y divide-gray-200">
                        <!-- 交易資料會在這裡動態生成 -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between mt-6">
                <button id="back-to-upload" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    返回
                </button>
                <button id="proceed-to-submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    確認並送出
                </button>
            </div>
        </section>

        <!-- 步驟3：結果顯示 -->
        <section id="result-section" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">送出結果</h2>
            
            <div id="result-content" class="p-4">
                <!-- 結果訊息會在這裡顯示 -->
            </div>

            <div class="mt-6">
                <button id="new-upload" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    上傳新檔案
                </button>
            </div>
        </section>
    </main>

    <footer class="fixed bottom-0 w-full bg-white p-4 border-t border-gray-200 text-sm text-center text-gray-600">
        信用卡月結單至Notion應用 &copy; 2025
    </footer>

    <script>
        // 初始化 PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // 預設CORS代理（有多個選項，以備一個不可用時）
        const DEFAULT_PROXIES = [
            "https://corsproxy.io/?",
            "https://cors-anywhere.herokuapp.com/",
            "https://api.allorigins.win/raw?url="
        ];
        
        // Notion API端點
        const NOTION_API_BASE = "https://api.notion.com/v1";
        const NOTION_VERSION = "2022-06-28";
        
        // 選擇可用的CORS代理
        async function getWorkingProxy() {
            // 先檢查用戶是否提供了自定義代理
            const customProxy = document.getElementById('cors-proxy').value.trim();
            if (customProxy) {
                // 確保代理URL以/結尾
                return customProxy.endsWith('/') ? customProxy : customProxy + '/';
            }
            
            // 測試預設代理
            for (const proxy of DEFAULT_PROXIES) {
                try {
                    const testUrl = `${proxy}https://api.notion.com/`;
                    const response = await fetch(testUrl, {
                        method: 'HEAD',
                        timeout: 3000
                    }).catch(() => null);
                    
                    if (response && response.status !== 429) { // 429 是 Too Many Requests
                        return proxy;
                    }
                } catch (error) {
                    console.log(`代理 ${proxy} 不可用`, error);
                }
            }
            
            // 如果所有代理都不可用，使用第一個（會提示用戶出錯）
            return DEFAULT_PROXIES[0];
        }

        // 更新商家分類對照表以匹配Notion中的固定類別
        const categoryMap = {
            // 生活用品
            'SUPERMARKET': '生活用品', 'PARKNSHOP': '生活用品', 'WELLCOME': '生活用品',
            'WATSONS': '生活用品', 'MARKET': '生活用品',

            // 知識學習
            'BOOKSTORE': '知識學習', 'COURSE': '知識學習', 'EDUCATION': '知識學習',

            // 休閒娛樂
            'MOVIE': '休閒娛樂', 'CINEMA': '休閒娛樂', 'NETFLIX': '休閒娛樂',
            'SPOTIFY': '休閒娛樂', 'DISNEY': '休閒娛樂', 'GAME': '休閒娛樂',

            // 交通
            'UBER': '交通', 'TAXI': '交通', 'MTR': '交通', 'BUS': '交通',
            'TRANSPORT': '交通', 'OCTOPUS': '交通',

            // 健康醫療
            'DOCTOR': '健康醫療', 'CLINIC': '健康醫療', 'HOSPITAL': '健康醫療',
            'PHARMACY': '健康醫療', 'MEDICAL': '健康醫療',

            // 訂閱
            'SUBSCRIPTION': '訂閱', 'MAGAZINE': '訂閱', 'MEMBERSHIP': '訂閱',

            // 固定支出
            'RENT': '固定支出', 'MORTGAGE': '固定支出', 'LOAN': '固定支出',

            // 美妝
            'COSMETICS': '美妝', 'BEAUTY': '美妝', 'SKINCARE': '美妝',

            // 服飾配件
            'CLOTHING': '服飾配件', 'FASHION': '服飾配件', 'ACCESSORIES': '服飾配件',

            // 餐飲
            'CAFE': '餐飲', 'RESTAURANT': '餐飲', 'MCDONALDS': '餐飲',
            'STARBUCKS': '餐飲', 'FOOD': '餐飲', 'PIZZA': '餐飲',

            // 其他
            'OTHER': '其他'
        };

        // 根據商家名稱分類交易
        function categorizeTransaction(description) {
            description = description.toUpperCase();
            
            for (const [keyword, category] of Object.entries(categoryMap)) {
                if (description.includes(keyword.toUpperCase())) {
                    return category;
                }
            }
            
            return '其他'; // 預設類別
        }
        
        // 獲取類別的顏色
        function getCategoryColor(category) {
            const colorMap = {
                '餐飲': 'bg-red-100 text-red-800',
                '交通': 'bg-blue-100 text-blue-800',
                '購物': 'bg-yellow-100 text-yellow-800',
                '娛樂': 'bg-purple-100 text-purple-800',
                '繳費': 'bg-green-100 text-green-800',
                '健康': 'bg-indigo-100 text-indigo-800',
                '費用': 'bg-gray-100 text-gray-800',
                '其他': 'bg-gray-100 text-gray-800'
            };
            
            return colorMap[category] || 'bg-gray-100 text-gray-800';
        }

        // 用於存儲解析的交易資料
        let transactions = [];

        // 設置頁面的事件處理程序
        document.addEventListener('DOMContentLoaded', function() {
            const uploadButton = document.getElementById('upload-button');
            const pdfUpload = document.getElementById('pdf-upload');
            const backToUpload = document.getElementById('back-to-upload');
            const proceedToSubmit = document.getElementById('proceed-to-submit');
            const newUpload = document.getElementById('new-upload');
            const imageUploadButton = document.getElementById('image-upload-button');
            const dropZone = document.getElementById('drop-zone');
            
            // 上傳按鈕點擊事件
            uploadButton.addEventListener('click', function() {
                pdfUpload.click();
            });
            
            // 檔案選擇事件
            pdfUpload.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (!file || file.type !== 'application/pdf') {
                        alert('請上傳有效的 PDF 檔案！');
                        showLoading(false);
                        return;
                    }
                    showLoading(true);
                    processPDF(file);
                }
            });
            
            // 圖片上傳按鈕點擊事件
            imageUploadButton.addEventListener('click', () => {
                const imageUploadInput = document.createElement('input');
                imageUploadInput.type = 'file';
                imageUploadInput.accept = 'image/*';
                imageUploadInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        showLoading(true);
                        processImage(file);
                    }
                });
                imageUploadInput.click();
            });
            
            // 返回按鈕點擊事件
            backToUpload.addEventListener('click', function() {
                showSection('upload-section');
                setActiveStep(1);
            });
            
            // 送出按鈕點擊事件
            proceedToSubmit.addEventListener('click', function() {
                // 驗證 Notion API 密鑰和資料庫 ID
                const notionToken = document.getElementById('notion-token').value.trim();
                const databaseId = document.getElementById('database-id').value.trim();
                
                if (!notionToken) {
                    alert('請輸入 Notion API 密鑰');
                    document.getElementById('notion-token').focus();
                    return;
                }
                
                if (!databaseId) {
                    alert('請輸入 Notion 資料庫 ID');
                    document.getElementById('database-id').focus();
                    return;
                }
                
                // 檢查API密鑰格式
                if (!notionToken.startsWith('secret_')) {
                    alert('Notion API 密鑰格式錯誤，應以 secret_ 開頭');
                    document.getElementById('notion-token').focus();
                    return;
                }
                
                showLoading(true);
                submitToNotion();
            });
            
            // 上傳新檔案按鈕點擊事件
            newUpload.addEventListener('click', function() {
                // 清除之前的資料，包括 API 密鑰和資料庫 ID
                pdfUpload.value = '';
                document.getElementById('notion-token').value = '';
                document.getElementById('database-id').value = '';
                transactions = [];
                
                showSection('upload-section');
                setActiveStep(1);
            });
            
            // 拖放支持
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.type === 'application/pdf') {
                        showLoading(true);
                        processPDF(file);
                    } else if (file.type.startsWith('image/')) {
                        showLoading(true);
                        processImage(file);
                    } else {
                        alert('請上傳PDF檔案或圖片檔案');
                    }
                }
            });
        });

        // 設置活動步驟
        function setActiveStep(stepNumber) {
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index + 1 === stepNumber) {
                    step.classList.remove('text-gray-400', 'border-gray-200');
                    step.classList.add('text-blue-600', 'border-blue-600');
                } else if (index + 1 < stepNumber) {
                    step.classList.remove('text-blue-600', 'border-blue-600', 'text-gray-400', 'border-gray-200');
                    step.classList.add('text-gray-600', 'border-gray-400');
                } else {
                    step.classList.remove('text-blue-600', 'border-blue-600', 'text-gray-600', 'border-gray-400');
                    step.classList.add('text-gray-400', 'border-gray-200');
                }
            });
        }

        // 顯示/隱藏載入指示器
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.style.display = 'flex';
            } else {
                loading.style.display = 'none';
            }
        }

        // 顯示指定區域，隱藏其他區域
        function showSection(sectionId) {
            const sections = ['upload-section', 'preview-section', 'result-section'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (id === sectionId) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
        }

        // 處理PDF檔案
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                // 提取文本內容
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                console.log('從PDF提取的文本:', fullText);
                
                // 提取交易資料
                extractTransactions(fullText);
                
                // 如果沒有提取到交易，顯示提示
                if (transactions.length === 0) {
                    alert('未能從PDF中提取到任何交易資料。請確保PDF格式正確。');
                    showLoading(false);
                    return;
                }
                
                // 清空先前可能存在的敏感資料
                document.getElementById('notion-token').value = '';
                document.getElementById('database-id').value = '';
                
                // 顯示預覽
                populateTransactionsPreview();
                showSection('preview-section');
                setActiveStep(2);
                
            } catch (error) {
                console.error('處理 PDF 時出錯:', error);
                alert('處理 PDF 時出錯: ' + error.message);
            } finally {
                showLoading(false); // 確保無論成功或失敗都隱藏 loading
            }
        }

        // 新增圖片上傳與解析功能
        function processImage(file) {
            Tesseract.recognize(
                file, // 圖片文件
                'eng', // 語言設置
                {
                    logger: info => console.log(info) // 可選：用於調試的日誌
                }
            ).then(({ data: { text } }) => {
                console.log('OCR 提取的文字:', text);
                extractTransactions(text); // 使用現有的交易提取邏輯
                
                // 如果沒有提取到交易，顯示提示
                if (transactions.length === 0) {
                    alert('未能從圖片中提取到任何交易資料。請確保圖片清晰且包含交易資訊。');
                    showLoading(false);
                    return;
                }
                
                // 清空先前可能存在的敏感資料
                document.getElementById('notion-token').value = '';
                document.getElementById('database-id').value = '';
                
                populateTransactionsPreview(); // 填充預覽表格
                showSection('preview-section');
                setActiveStep(2);
            }).catch(error => {
                console.error('處理圖片時出錯:', error);
                alert('處理圖片時出錯: ' + error.message);
            }).finally(() => {
                showLoading(false);
            });
        }

        // 更新交易解析邏輯以提取所需的欄位
        function extractTransactions(text) {
            console.log('提取的文字:', text); // 加入日誌
            
            // 清空之前的交易記錄
            transactions = [];
            
            // 正則表達式匹配交易記錄
            // 格式：日期 日期 描述 金額
            const transactionRegex = /(\d{1,2} [A-Z]{3} \d{4})\s+(\d{1,2} [A-Z]{3} \d{4})\s+([^\n]+?)\s+([\d,.]+(?:-)?)\s*$/gm;
            
            let match;
            while ((match = transactionRegex.exec(text)) !== null) {
                console.log('匹配到的交易:', match); // 加入日誌
                
                // 提取日期、描述和金額
                const transactionDate = match[1]; // 第一個日期
                const postingDate = match[2];     // 第二個日期
                const description = match[3].trim();
                const amountStr = match[4].replace(',', '');
                const amount = parseFloat(amountStr);
                
                // 根據商家名稱分類交易
                const category = categorizeTransaction(description);
                
                // 將交易添加到陣列
                transactions.push({
                    name: description,
                    amount: amount,
                    transactionDate: transactionDate,
                    category: category,
                    note: '',
                    paymentMethod: '信用卡'
                });
            }
            
            console.log('提取的交易資料:', transactions);
        }

        // 更新預覽表格以顯示新欄位
        function populateTransactionsPreview() {
            const tbody = document.getElementById('transactions-preview');
            tbody.innerHTML = '';

            transactions.forEach((transaction, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                // 名稱
                const nameCell = document.createElement('td');
                nameCell.className = 'px-3 py-2 text-sm';
                nameCell.textContent = transaction.name;
                row.appendChild(nameCell);

                // 金額
                const amountCell = document.createElement('td');
                amountCell.className = 'px-3 py-2 text-sm';
                amountCell.textContent = transaction.amount.toFixed(2);
                row.appendChild(amountCell);

                // 交易日期
                const dateCell = document.createElement('td');
                dateCell.className = 'px-3 py-2 text-sm';
                dateCell.textContent = transaction.transactionDate;
                row.appendChild(dateCell);

                // 類別
                const categoryCell = document.createElement('td');
                categoryCell.className = 'px-3 py-2 text-sm';
                
                const categorySpan = document.createElement('span');
                categorySpan.className = 'category-badge ' + getCategoryColor(transaction.category);
                categorySpan.textContent = transaction.category;
                
                categoryCell.appendChild(categorySpan);
                row.appendChild(categoryCell);

                // 備註
                const noteCell = document.createElement('td');
                noteCell.className = 'px-3 py-2 text-sm';
                
                const noteInput = document.createElement('input');
                noteInput.type = 'text';
                noteInput.className = 'border rounded px-2 py-1 w-full';
                noteInput.value = transaction.note;
                noteInput.addEventListener('input', (e) => {
                    transactions[index].note = e.target.value;
                });
                
                noteCell.appendChild(noteInput);
                row.appendChild(noteCell);

                // 付款方式
                const paymentMethodCell = document.createElement('td');
                paymentMethodCell.className = 'px-3 py-2 text-sm';
                
                const paymentMethodSelect = document.createElement('select');
                paymentMethodSelect.className = 'border rounded px-2 py-1 w-full';
                
                ['信用卡', '現金', '轉帳'].forEach((method) => {
                    const option = document.createElement('option');
                    option.value = method;
                    option.textContent = method;
                    if (method === transaction.paymentMethod) {
                        option.selected = true;
                    }
                    paymentMethodSelect.appendChild(option);
                });
                
                paymentMethodSelect.addEventListener('change', (e) => {
                    transactions[index].paymentMethod = e.target.value;
                });
                
                paymentMethodCell.appendChild(paymentMethodSelect);
                row.appendChild(paymentMethodCell);

                tbody.appendChild(row);
            });
        }

        // 直接調用Notion API的函數
        async function callNotionAPI(endpoint, method, token, body = null) {
            const proxy = await getWorkingProxy();
            const url = `${proxy}${NOTION_API_BASE}/${endpoint}`;
            
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Notion-Version': NOTION_VERSION,
                'Content-Type': 'application/json'
            };
            
            const options = {
                method: method,
                headers: headers
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API請求失敗：${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API調用錯誤:', error);
                throw error;
            }
        }

        // 檢查資料庫訪問權限
        async function checkDatabaseAccess(token, databaseId) {
            try {
                await callNotionAPI(`databases/${databaseId}`, 'GET', token);
                return { success: true };
            } catch (error) {
                if (error.message.includes('object_not_found')) {
                    return { success: false, message: '找不到資料庫，請檢查資料庫ID是否正確' };
                } else if (error.message.includes('unauthorized')) {
                    return { success: false, message: 'API密鑰無效或權限不足' };
                } else {
                    return { success: false, message: `無法訪問資料庫: ${error.message}` };
                }
            }
        }

        // 創建Notion頁面
        async function createNotionPage(token, databaseId, transaction) {
            const pageData = {
                parent: { database_id: databaseId },
                properties: {
                    名稱: { title: [{ text: { content: transaction.name } }] },
                    金額: { number: transaction.amount },
                    交易日期: { date: { start: transaction.transactionDate } },
                    類別: { select: { name: transaction.category } },
                    備註: { rich_text: [{ text: { content: transaction.note || '' } }] },
                    付款方式: { select: { name: transaction.paymentMethod } },
                }
            };
            
            return await callNotionAPI('pages', 'POST', token, pageData);
        }

        // 送出資料至 Notion
        async function submitToNotion() {
            try {
                const notionToken = document.getElementById('notion-token').value.trim();
                const databaseId = document.getElementById('database-id').value.trim();
                
                // 再次驗證輸入
                if (!notionToken || !databaseId) {
                    alert('請輸入Notion API密鑰和資料庫ID');
                    showLoading(false);
                    return;
                }
                
                // 顯示處理進度
                const resultContent = document.getElementById('result-content');
                resultContent.innerHTML = `
                    <div class="p-4 bg-blue-100 text-blue-800 rounded-lg">
                        <p>正在處理交易資料，請稍候...</p>
                        <div class="mt-2 bg-blue-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="progress-text">0/${transactions.length} 筆交易已處理</p>
                    </div>
                `;
                
                showSection('result-section');
                setActiveStep(3);
                
                // 首先檢查資料庫訪問權限
                const dbCheckResult = await checkDatabaseAccess(notionToken, databaseId);
                if (!dbCheckResult.success) {
                    throw new Error(dbCheckResult.message);
                }
                
                // 處理成功及失敗數量統計
                let successCount = 0;
                let failCount = 0;
                let errors = [];
                
                // 逐個處理交易
                for (let i = 0; i < transactions.length; i++) {
                    try {
                        await createNotionPage(notionToken, databaseId, transactions[i]);
                        successCount++;
                    } catch (error) {
                        failCount++;
                        errors.push({
                            transaction: transactions[i].name,
                            error: error.message
                        });
                    }
                    
                    // 更新進度
                    const progressPercent = Math.round(((i + 1) / transactions.length) * 100);
                    document.getElementById('progress-bar').style.width = `${progressPercent}%`;
                    document.getElementById('progress-text').textContent = 
                        `${i + 1}/${transactions.length} 筆交易已處理`;
                }
                
                // 顯示最終結果
                resultContent.innerHTML = `
                    <div class="p-4 ${successCount > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} rounded-lg">
                        <p>處理完成！</p>
                        <p>成功: ${successCount} 筆</p>
                        <p>失敗: ${failCount} 筆</p>
                        ${failCount > 0 ? `
                        <div class="mt-2 p-2 bg-white rounded">
                            <p class="font-bold">失敗詳情:</p>
                            <ul class="list-disc pl-5">
                                ${errors.map(e => `<li>${e.transaction}: ${e.error}</li>`).join('')}
                            </ul>
                        </div>` : ''}
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 text-blue-800 rounded-lg">
                        <p class="text-sm">為了保障您的資料安全，API 密鑰和資料庫 ID 不會被儲存。下次使用時需要重新輸入。</p>
                    </div>
                `;
                
                // 清空敏感資料
                document.getElementById('notion-token').value = '';
                document.getElementById('database-id').value = '';
                
            } catch (error) {
                console.error('送出資料至 Notion 時出錯:', error);
                
                const resultContent = document.getElementById('result-content');
                resultContent.innerHTML = `
                    <div class="p-4 bg-red-100 text-red-800 rounded-lg">
                        <p>處理交易時出錯:</p>
                        <p class="mt-2 p-2 bg-white rounded">${error.message}</p>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 text-yellow-800 rounded-lg">
                        <p class="text-sm">如果您遇到CORS相關錯誤，請嘗試以下操作:</p>
                        <ul class="list-disc pl-5 text-sm">
                            <li>使用其他CORS代理服務</li>
                            <li>使用瀏覽器擴充功能暫時禁用CORS（如：<a href="https://chrome.google.com/webstore/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank" class="underline">CORS Unblock</a>）</li>
                            <li>創建並部署自己的CORS代理（如Cloudflare Worker）</li>
                        </ul>
                    </div>
                `;
            } finally {
                showLoading(false); // 確保無論成功或失敗都隱藏 loading
            }
        }
    </script>
</body>
</html>
